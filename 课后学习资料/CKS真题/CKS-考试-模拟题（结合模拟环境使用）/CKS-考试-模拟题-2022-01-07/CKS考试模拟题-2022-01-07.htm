<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=gb2312">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:等线;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"等线 Light";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"\@等线";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"\@等线 Light";}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:等线;}
h1
	{mso-style-link:"标题 1 字符";
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:240%;
	page-break-after:avoid;
	font-size:22.0pt;
	font-family:等线;}
h2
	{mso-style-link:"标题 2 字符";
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:173%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"等线 Light";}
h3
	{mso-style-link:"标题 3 字符";
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:173%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:等线;}
h4
	{mso-style-link:"标题 4 字符";
	margin-top:14.0pt;
	margin-right:0cm;
	margin-bottom:14.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:156%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"等线 Light";}
h5
	{mso-style-link:"标题 5 字符";
	margin-top:14.0pt;
	margin-right:0cm;
	margin-bottom:14.5pt;
	margin-left:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	line-height:156%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:等线;}
p.MsoCommentText, li.MsoCommentText, div.MsoCommentText
	{mso-style-link:"批注文字 字符";
	margin:0cm;
	font-size:10.5pt;
	font-family:等线;}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{mso-style-link:"页眉 字符";
	margin:0cm;
	text-align:center;
	layout-grid-mode:char;
	border:none;
	padding:0cm;
	font-size:9.0pt;
	font-family:等线;}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{mso-style-link:"页脚 字符";
	margin:0cm;
	layout-grid-mode:char;
	font-size:9.0pt;
	font-family:等线;}
p.MsoDate, li.MsoDate, div.MsoDate
	{mso-style-link:"日期 字符";
	margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:5.0pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:等线;}
a:link, span.MsoHyperlink
	{color:#0563C1;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:#954F72;
	text-decoration:underline;}
p.MsoCommentSubject, li.MsoCommentSubject, div.MsoCommentSubject
	{mso-style-link:"批注主题 字符";
	margin:0cm;
	font-size:10.5pt;
	font-family:等线;
	font-weight:bold;}
p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
	{mso-style-link:"批注框文本 字符";
	margin:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:9.0pt;
	font-family:等线;}
p.MsoNoSpacing, li.MsoNoSpacing, div.MsoNoSpacing
	{margin:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:等线;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin:0cm;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:21.0pt;
	font-size:10.5pt;
	font-family:等线;}
span.a
	{mso-style-name:"页眉 字符";
	mso-style-link:页眉;}
span.a0
	{mso-style-name:"页脚 字符";
	mso-style-link:页脚;}
span.a1
	{mso-style-name:"批注框文本 字符";
	mso-style-link:批注框文本;}
span.1
	{mso-style-name:"标题 1 字符";
	mso-style-link:"标题 1";
	font-weight:bold;}
span.a2
	{mso-style-name:"批注文字 字符";
	mso-style-link:批注文字;}
span.a3
	{mso-style-name:"批注主题 字符";
	mso-style-link:批注主题;
	font-weight:bold;}
span.2
	{mso-style-name:"标题 2 字符";
	mso-style-link:"标题 2";
	font-family:"等线 Light";
	font-weight:bold;}
span.3
	{mso-style-name:"标题 3 字符";
	mso-style-link:"标题 3";
	font-weight:bold;}
span.4
	{mso-style-name:"标题 4 字符";
	mso-style-link:"标题 4";
	font-family:"等线 Light";
	font-weight:bold;}
span.5
	{mso-style-name:"标题 5 字符";
	mso-style-link:"标题 5";
	font-weight:bold;}
span.a4
	{mso-style-name:"日期 字符";
	mso-style-link:日期;}
.MsoChpDefault
	{font-family:等线;}
 /* Page Definitions */
 @page WordSection1
	{size:841.9pt 1190.55pt;
	margin:36.0pt 36.0pt 36.0pt 36.0pt;
	layout-grid:15.6pt;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>

</head>

<body lang=ZH-CN link="#0563C1" vlink="#954F72" style='word-wrap:break-word;
text-justify-trim:punctuation'>

<div class=WordSection1 style='layout-grid:15.6pt'>

<p class=MsoNormal align=center style='text-align:center'><b><span lang=EN-US
style='font-size:26.0pt'>CKS 1.22</span></b><b><span style='font-size:26.0pt'>考题</span></b></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1>考试流程</h1>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>1</span>、尽量提前<span
lang=EN-US> 10 </span>分钟左右进入倒计时页面（<span lang=EN-US>https://www.examslocal.com </span>点击登录<span
lang=EN-US>-&gt;Or SignIn With-&gt;</span>点击按钮<span lang=EN-US> My Exams</span>），
等待出现进入考试系统的按钮（考官到位会出现）， 刚开始考官会让你出示证件，然后考官会让你拿摄像头环绕考试环境一周，确保房间无外人、桌面上没杂物，然后考官会让我们在考试系统里打开共享屏幕和摄像头按钮；
最后考官会告诉我们一些注意事项，比如记事本功能，以及可以查阅哪些网站资料等等。 考试过程中如有意外状况， 可以在线与考官交流（文字）， 并争取你应有的权益；</p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>2</span>、只 允 许 打
开 两 个 标 签 页 ， 一 个 是 考 试 系 统 ， 另 一 个 建 议 打 开 官 网 文 档<span lang=EN-US>https://kubernetes.io/zh/docs/home/</span>，
将官网相关参考资料保存好书签， 方便快速查找内容；</p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>3</span>、<span
lang=EN-US>K8s </span>集群环境采用<span lang=EN-US> ubuntu </span>系统，不用担心，会普通用户执行<span
lang=EN-US> sudo -i </span>切<span lang=EN-US> root </span>就行了， 而且也基本不用切<span
lang=EN-US> root </span>操作。</p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>4</span>、考试系统界面</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5</span>、答题结束后，
在<span lang=EN-US> Exam Controls </span>里结束考试。</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>CKS </span>考试概要：</h1>

<p class=MsoNormal>考试模式：线上考试</p>

<p class=MsoNormal>考试时间：<span lang=EN-US> 2 </span>小时</p>

<p class=MsoNormal>题目数量：<span lang=EN-US> 16 </span>题</p>

<p class=MsoNormal>题目说明： 目前只支持英文， 可借助<span lang=EN-US> Google </span>浏览器右击翻译阅读。</p>

<p class=MsoNormal>题目变化： 每次考题会对里面涉及的名称个别微调， 还有题目顺序。</p>

<p class=MsoNormal>注： 以下解读借助了程序翻译， 可能会有点生硬， 主要熟悉题目类型和答案。</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-size:12.0pt;color:red;background:yellow'>根据近几次考试结果反馈，<span
lang=EN-US>cks</span>是有多套考试环境的，差别不大。主要的差别是在修改<span lang=EN-US>kube-apiserver</span>配置文件相关的几道题，有的考试环境已经将<span
lang=EN-US>volumeMounts </span>和<span lang=EN-US>volumes</span>写好了，有的考试环境却没写。<span
lang=EN-US>volumeMounts</span>和<span lang=EN-US>volumes</span>写好了的，就不要重复添加了，否则会报错。</span></p>

<p class=MsoNormal><span style='font-size:12.0pt;color:red;background:yellow'>这个注意事项，在模拟题里已经用红色字体备注了。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-size:18.0pt;color:red'>注意：此模拟题的每道题的官网参考资料，都是有带图片的。</span></p>

<p class=MsoNormal><span style='font-size:18.0pt;color:red'>如果你打开的这个网页模拟题里看不到图片，可能是有异常，请与我联系。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img width=798 height=603 id="图片 43"
src="CKS考试模拟题-2022-01-07.files/image001.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1>题库更新内容：</h1>

<h2><span lang=EN-US>2021</span>年<span lang=EN-US>12</span>月<span lang=EN-US>28</span>日</h2>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span lang=EN-US>1</span>、更新“日志审计 <span lang=EN-US>log
audit</span>”</b></p>

<p class=MsoNormal><span lang=EN-US><img width=854 height=305 id="图片 23"
src="CKS考试模拟题-2022-01-07.files/image002.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span lang=EN-US>2</span>、更新“<span lang=EN-US>Dockerfile</span>检测”</b></p>

<p class=MsoNormal><span lang=EN-US><img width=955 height=259 id="图片 46"
src="CKS考试模拟题-2022-01-07.files/image003.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span lang=EN-US>3</span>、更新“删除非无状态和启用特权的<span
lang=EN-US> Pod</span>”</b></p>

<p class=MsoNormal><span lang=EN-US><img width=641 height=198 id="图片 59"
src="CKS考试模拟题-2022-01-07.files/image004.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span lang=EN-US>4</span>、更新“<span lang=EN-US>Sysdig
&amp; falco</span>”</b></p>

<p class=MsoNormal><span lang=EN-US><img width=812 height=140 id="图片 62"
src="CKS考试模拟题-2022-01-07.files/image005.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h2><span lang=EN-US>2021</span>年<span lang=EN-US>12</span>月<span lang=EN-US>31</span>日</h2>

<p class=MsoNormal><b>有下面题目，在最新的<span lang=EN-US>1.22</span>考试中有改动：</b></p>

<p class=MsoNormal><span lang=EN-US>1</span>、<span lang=EN-US>kube-bench </span>修复不安全项</p>

<p class=MsoNormal><span lang=EN-US>3</span>、默认网络策略<span lang=EN-US> default
NetworkPolicy</span></p>

<p class=MsoNormal><span lang=EN-US>5</span>、日志审计<span lang=EN-US> log audit</span></p>

<p class=MsoNormal><span lang=EN-US>7</span>、<span lang=EN-US>Dockerfile</span>检测</p>

<p class=MsoNormal><span lang=EN-US>12</span>、<span lang=EN-US>AppArmor</span></p>

<p class=MsoNormal><span lang=EN-US>14</span>、<span lang=EN-US>Pod </span>安全策略（<span
lang=EN-US>PodSecurityPolicy PSP</span>）</p>

<p class=MsoNormal><span lang=EN-US>15</span>、启用<span lang=EN-US>API server</span>认证</p>

<p class=MsoNormal><span lang=EN-US>16</span>、<span lang=EN-US>ImagePolicyWebhook</span>容器镜像扫描</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>可以在整个文档里搜索<span lang=EN-US>1.22</span>，检查<span lang=EN-US>1.22</span>考试里新的调整项。</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>1</span>、<span lang=EN-US>kube-bench </span>修复不安全项</h1>

<p class=MsoNormal align=left style='text-align:left'><span style='color:#00B0F0'>（需要手动初始化环境）</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>context</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>A CIS
Benchmark tool was run against the <span style='color:#0070C0'>kubeadm-created</span>
cluster and found multiple issues that must be addressed immediately.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>Task</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Fix all
issues via configuration and restart the affected components to ensure the new
settings take effect.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Fix all of
the following violations that were found against the<span style='color:#0070C0'>
API server:</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1.2.7&nbsp;&nbsp;&nbsp;
Ensure that the&nbsp; <span style='color:#0070C0'>--authorization-mode</span> argument
is not set to<span style='color:#0070C0'> AlwaysAllow</span>&nbsp; &nbsp;&nbsp;FAIL
</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1.2.8&nbsp;&nbsp;&nbsp;
Ensure that the&nbsp; <span style='color:#0070C0'>--authorization-mode</span> argument
includes <span style='color:#0070C0'>Node</span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FAIL
</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1.2.9&nbsp;&nbsp;&nbsp;
Ensure that the <span style='color:#0070C0'>&nbsp;--authorization-mode</span> argument
includes <span style='color:#0070C0'>RBAC</span>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FAIL
</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1.2.18&nbsp;&nbsp;
Ensure that the &nbsp;<span style='color:#0070C0'>--insecure-bind-address</span>
argument is <span style='color:#0070C0'>not set</span>&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FAIL&nbsp;&nbsp;
</span>（<span lang=EN-US>1.22</span>中，这两项题目里没有明确给出，但是最好也修改）</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1.2.19&nbsp;&nbsp;
Ensure that the &nbsp;<span style='color:#0070C0'>--insecure-port</span> argument
is set to <span style='color:#0070C0'>0&nbsp; </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FAIL&nbsp;
</span>（<span lang=EN-US>1.22</span>中，这两项题目里没有明确给出，但是最好也修改）</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Fix all of
the following violations that were found against the <span style='color:#0070C0'>kubelet:</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>4.2.1&nbsp;&nbsp;&nbsp;
Ensure that the&nbsp;&nbsp; &nbsp;<span style='color:#0070C0'>anonymous-auth</span>
argument is set to <span style='color:#0070C0'>false</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FAIL</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>4.2.2&nbsp;&nbsp;&nbsp;
Ensure that the &nbsp;<span style='color:#0070C0'>--authorization-mode</span>
argument is not set to <span style='color:#0070C0'>AlwaysAllow</span>&nbsp; &nbsp;&nbsp;&nbsp;FAIL</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Use webhook
authn/authz where possible.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Fix all of
the following violations that were found against <span style='color:#0070C0'>etcd:</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>2.2&nbsp;&nbsp;&nbsp;&nbsp;
Ensure that the &nbsp;<span style='color:#0070C0'>--client-cert-auth</span>
argument is set to<span style='color:#0070C0'> true </span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FAIL</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>解读：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'>修复以下<span lang=EN-US>
apiserver </span>发现的问题：</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US><img
width=361 height=244 id="图片 4" src="CKS考试模拟题-2022-01-07.files/image006.jpg"></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>修复以下<span lang=EN-US>
kubelet </span>发现的问题：</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US><img
width=365 height=124 id="图片 5" src="CKS考试模拟题-2022-01-07.files/image007.jpg"></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>修复以下<span lang=EN-US> etcd </span>发现的问题：</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US><img
width=385 height=65 id="图片 6" src="CKS考试模拟题-2022-01-07.files/image008.jpg"></span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/reference/config-api/kubelet-config.v1beta1/">https://kubernetes.io/zh/docs/reference/config-api/kubelet-config.v1beta1/</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1027 height=254
id="图片 61" src="CKS考试模拟题-2022-01-07.files/image009.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>初始化这道题的环境</span></b></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'>请先执行如下命令，模拟这道题的初始环境。（将以下所有命令粘贴到<span
lang=EN-US>master01</span>执行。）</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#7030A0'>sed -i 's/authorization-mode=Node,RBAC/authorization-mode=AlwaysAllow/'
/etc/kubernetes/manifests/kube-apiserver.yaml</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#7030A0'>sed -i '/authorization-mode/a\&nbsp;&nbsp;&nbsp; -
--insecure-bind-address=0.0.0.0' /etc/kubernetes/manifests/kube-apiserver.yaml</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#7030A0'>sed -i 's/enabled: false/enabled: true/'
/var/lib/kubelet/config.yaml</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#7030A0'>sed -i 's/mode: Webhook/mode: AlwaysAllow/'
/var/lib/kubelet/config.yaml</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#7030A0'>sed -i
's/--client-cert-auth=true/--client-cert-auth=false/'
/etc/kubernetes/manifests/etcd.yaml</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#7030A0'>systemctl daemon-reload</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#7030A0'>systemctl restart kubelet.service</span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSCS00201</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>需要从控制台<span lang=EN-US>ssh</span>到<span lang=EN-US>master</span>节点。</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>ssh root@master01</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>1 </span><span
style='color:#0070C0'>修改<span lang=EN-US>api-server</span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kube-bench master&nbsp;
#</span><span style='color:#C45911'>可以使用这条命令查，要记住</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>[FAIL]
1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow
(Automated)</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>[FAIL]
1.2.8 Ensure that the --authorization-mode argument includes Node (Automated)</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>[FAIL]
1.2.9 Ensure that the --authorization-mode argument includes RBAC (Automated)</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>[FAIL]
1.2.18 Ensure that the --insecure-bind-address argument is not set (Automated)</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>[FAIL]
1.2.19 Ensure that the --insecure-port argument is set to 0 (Automated)</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>。。。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1.2.7 Edit
the API server pod specification file <span style='color:#0070C0'>/etc/kubernetes/manifests/kube-apiserver.yaml</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>on the
master node and set the --authorization-mode parameter to values other than
AlwaysAllow.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>One such
example could be as below.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>--authorization-mode=RBAC</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1.2.8 Edit
the API server pod specification file <span style='color:#0070C0'>/etc/kubernetes/manifests/kube-apiserver.yaml</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>on the
master node and set the --authorization-mode parameter to a value that includes
Node.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>--authorization-mode=Node,RBAC</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1.2.9 Edit
the API server pod specification file <span style='color:#0070C0'>/etc/kubernetes/manifests/kube-apiserver.yaml</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>on the
master node and set the --authorization-mode parameter to a value that includes
RBAC,</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>for
example:</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>--authorization-mode=Node,RBAC</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1.2.18 Edit
the API server pod specification file <span style='color:#0070C0'>/etc/kubernetes/manifests/kube-apiserver.yaml</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>on the
master node and remove the <span style='color:#0070C0'>--insecure-bind-address</span>
parameter.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1.2.19 Edit
the API server pod specification file<span style='color:#0070C0'>
/etc/kubernetes/manifests/kube-apiserver.yaml</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>on the
master node and set the below parameter.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>--insecure-port=0</span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>修改之前，备份一下配置文件。</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>mkdir bak1</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>cp /etc/kubernetes/manifests/kube-apiserver.yaml
&nbsp;bak1/</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vim
/etc/kubernetes/manifests/kube-apiserver.yaml</span></p>

<p class=MsoNormal><span lang=EN-US>#</span>修改、添加、删除相关内容</p>

<p class=MsoNormal><span lang=EN-US>#</span>修改<span lang=EN-US>authorization-mode</span>，注意<span
lang=EN-US>Node</span>和<span lang=EN-US>RBAC</span>之间的符号是英文状态的逗号，而不是点。</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>&nbsp;&nbsp;&nbsp; -
--authorization-mode=Node,RBAC</span></p>

<p class=MsoNormal><span lang=EN-US>#</span>添加或修改<span lang=EN-US>insecure-port=0</span>，如果考试中的<span
lang=EN-US>yaml</span>文件里已经存在<span lang=EN-US>insecure-port</span>了，则将其修改为<span
lang=EN-US>0</span>。</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>&nbsp;&nbsp;&nbsp; -
--<a name="_Hlk89287322">insecure-port</a>=0</span></p>

<p class=MsoNormal><span lang=EN-US>#</span>删除<span lang=EN-US>insecure-bind-address</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>&nbsp;&nbsp;&nbsp; - --insecure-bind-address=0.0.0.0</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>2 </span><span
style='color:#0070C0'>修改<span lang=EN-US>kubelet</span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kube-bench node&nbsp;
#</span><span style='color:#C45911'>可以使用这条命令查，要记住</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>[FAIL]
4.2.1 Ensure that the anonymous-auth argument is set to false (Automated)</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>[FAIL]
4.2.2 Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated)</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>。。。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>4.2.1 If
using a Kubelet config file, edit the file to set authentication: anonymous:
enabled to</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>false.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>If using
executable arguments, edit the kubelet service file</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><span
lang=EN-US> on each worker node and</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>set the
below parameter in KUBELET_SYSTEM_PODS_ARGS variable.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>--anonymous-auth=false</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Based on
your system, restart the kubelet service. For example:</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>systemctl daemon-reload</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>systemctl restart kubelet.service</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>4.2.2 If
using a Kubelet config file, edit the file to set authorization: mode to
Webhook. If</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>u<span
style='color:black'>sing executable arguments, edit the kubelet service file</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf </span><span
lang=EN-US style='color:black'>on each worker node and</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:black'>set the below parameter in KUBELET_AUTHZ_ARGS variable.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>--authorization-mode=Webhook</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Based on
your system, restart the kubelet service. For example:</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>systemctl daemon-reload</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>systemctl restart kubelet.service</span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='color:#00B050'>修复方法<span lang=EN-US>1</span>：</span></b></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>systemctl status
kubelet</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=857 height=379
id="图片 41" src="CKS考试模拟题-2022-01-07.files/image010.png"></span></p>

<p class=MsoNormal>其实在<span lang=EN-US>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span>中你也会看到<span
lang=EN-US>Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;</span>。</p>

<p class=MsoNormal>所以我们去修改这个文件</p>

<p class=MsoNormal>修改之前，备份一下配置文件。</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>mkdir bak1</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>cp /var/lib/kubelet/config.yaml
bak1/</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vim /var/lib/kubelet/config.yaml</span></p>

<p class=MsoNormal>修改</p>

<p class=MsoNormal><span lang=EN-US>apiVersion: kubelet.config.k8s.io/v1beta1</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>authentication:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; anonymous:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='color:#C45911'>enabled: false</span><span lang=EN-US
style='color:#00B050'>&nbsp;&nbsp;&nbsp; #</span><span style='color:#00B050'>改为<span
lang=EN-US>false</span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; webhook:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; cacheTTL: 0s</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; enabled: true</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; x509:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; clientCAFile:
/etc/kubernetes/pki/ca.crt</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>authorization:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; </span><span
lang=EN-US style='color:#C45911'>mode: Webhook</span><span lang=EN-US
style='color:#00B050'>&nbsp;&nbsp; #</span><span style='color:#00B050'>改为<span
lang=EN-US>Webhook</span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; webhook:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; cacheAuthorizedTTL: 0s</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; cacheUnauthorizedTTL: 0s</span></p>

<p class=MsoNormal><span lang=EN-US>cgroupDriver: systemd</span></p>

<p class=MsoNormal><span lang=EN-US>clusterDNS:</span></p>

<p class=MsoNormal><span lang=EN-US>- 10.96.0.10</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='color:#00B050'>修复方法<span lang=EN-US>2</span>：</span></b></p>

<p class=MsoNormal>考试中，任选一种方法即可，模拟环境里推荐第一种方法。</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>systemctl status
kubelet</span></p>

<p class=MsoNormal>修改之前，备份一下配置文件</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>mkdir bak1</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>cp /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
bak1/</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vi
/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>#</span>在<span lang=EN-US>[Service]</span>下面添加</p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>Environment=&quot;KUBELET_SYSTEM_PODS_ARGS=--anonymous-auth=false&quot;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>Environment=&quot;KUBELET_AUTHZ_ARGS=--authorization-mode=Webhook&quot;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>#</span>在<span lang=EN-US>ExecStart</span>后追加</p>

<p class=MsoNormal><span lang=EN-US>ExecStart=/usr/bin/kubelet
$KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS
$KUBELET_EXTRA_ARGS <span style='color:#00B050'>$KUBELET_SYSTEM_PODS_ARGS $KUBELET_AUTHZ_ARGS</span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>3 </span><span
style='color:#0070C0'>修改<span lang=EN-US>etcd</span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kube-bench&nbsp; #</span><span
style='color:#C45911'>可以使用这条命令查，要记住</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>[FAIL] 2.2
Ensure that the --client-cert-auth argument is set to true (Automated)</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>。。。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>2.2 Edit
the etcd pod specification file /etc/kubernetes/manifests/etcd.yaml on the
master</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>node and
set the below parameter.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>--client-cert-auth=&quot;true&quot;</span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>修改之前，备份一下配置文件。</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>mkdir bak1</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>cp /etc/kubernetes/manifests/etcd.yaml
&nbsp;bak1/</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vim
/etc/kubernetes/manifests/etcd.yaml</span></p>

<p class=MsoNormal>修改</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; - --<span
style='color:#C45911'>client-cert-auth=true&nbsp;&nbsp; </span><span
style='color:#00B050'>#</span></span><span style='color:#00B050'>修改为<span
lang=EN-US>true</span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>#</span>编辑完后重新加载配置文件，并重启<span lang=EN-US>kubelet</span></p>

<p class=MsoNormal><span lang=EN-US style='color:red'>systemctl daemon-reload&nbsp;&nbsp;
#</span><span style='color:red'>注意重新加载配置文件！</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>systemctl restart
kubelet.service</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>重启后，等待<span lang=EN-US>1</span>分钟，再检查。</p>

<p class=MsoNormal>确保所有的<span lang=EN-US>pod</span>都是<span lang=EN-US>Running</span>，特别是<span
lang=EN-US>kube-apiserver-master01</span>也正常。（考试时，也要确保这个<span lang=EN-US>apiserver</span>是正常的）</p>

<p class=MsoNormal>模拟环境里，还要确保<span lang=EN-US>pod</span>数量也正常，否会会影响下面的题目。</p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=798 height=603
id="图片 44" src="CKS考试模拟题-2022-01-07.files/image001.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>或者可以使用<span lang=EN-US>kube-bench</span>再次检查一下。</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>2</span>、<span lang=EN-US>Pod</span>指定<span lang=EN-US>ServiceAccount</span></h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>context</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>A Pod fails
to run because of an incorrectly specified ServiceAcccount.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>Task</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>create a
new ServiceAccount named <span style='color:#0070C0'>backend-sa</span> in the
existing namespace <span style='color:#0070C0'>qa</span> ,which must not have
access to <b>any</b> secrets.</span>（中文中这里翻译成：不自动挂载<span lang=EN-US>API</span>凭据）</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>lnspect the
Pod named <span style='color:#0070C0'>backend </span>running in the namespace <span
style='color:#0070C0'>qa</span> . Edit the Pod to use the newly created
serviceAccount <span style='color:#0070C0'>backend-sa</span>.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>You can
find the Pod's manifest file at <span style='color:#0070C0'>/cks/sa/pod1.yaml</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Ensure that
the modified specification is applied and the Pod is running.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Finally,
clean-up and delete the now unused serviceAccount that the Pod used initially.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>内容：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>pod </span>因错误指定了<span
lang=EN-US> ServiceAccout </span>无法运行</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>解读：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1. </span>在<span
lang=EN-US> qa </span>命名空间创建一个名为<span lang=EN-US> backend-sa </span>的<span
lang=EN-US> ServiceAccout</span>， 不允许访问任何<span lang=EN-US> secrets</span>。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>2. </span>在<span
lang=EN-US> qa </span>命名空间检查名为<span lang=EN-US> backend</span>的<span
lang=EN-US>pod</span>， 并编辑该<span lang=EN-US> pod</span>， 使用新创建的<span
lang=EN-US> ServiceAccout</span>。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>3. </span>您可以在<span
lang=EN-US style='color:#0070C0'>/cks/sa/pod1.yaml</span>中找到<span lang=EN-US>Pod</span>的清单文件</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>4. </span>确保已应用修改后的规范，并且<span
lang=EN-US>Pod</span>正在运行。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>5. </span>最后，清理并删除<span
lang=EN-US>Pod</span>最初使用的现在未使用的<span lang=EN-US>serviceAccount</span>。</p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-service-account/#%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B4%A6%E6%88%B7%E8%AE%BF%E9%97%AE-api-%E6%9C%8D%E5%8A%A1%E5%99%A8">https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-service-account/#%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E7%9A%84%E6%9C%8D%E5%8A%A1%E8%B4%A6%E6%88%B7%E8%AE%BF%E9%97%AE-api-%E6%9C%8D%E5%8A%A1%E5%99%A8</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1027 height=772
id="图片 60" src="CKS考试模拟题-2022-01-07.files/image011.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSCH00301</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vi qa-ns.yaml</span></p>

<p class=MsoNormal>根据官网修改如下内容</p>

<p class=MsoNormal><span lang=EN-US>apiVersion: v1</span></p>

<p class=MsoNormal><span lang=EN-US>kind: <a name="_Hlk89960413">ServiceAccount</a></span></p>

<p class=MsoNormal><span lang=EN-US>metadata:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; name:
backend-sa&nbsp;&nbsp; </span><span lang=EN-US style='color:#0070C0'>#</span><span
style='color:#0070C0'>修改<span lang=EN-US>name</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; namespace: qa&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US style='color:red'>#</span><span style='color:red'>注意添加<span
lang=EN-US>namespace</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>automountServiceAccountToken:
false&nbsp; </span><span lang=EN-US style='color:#0070C0'>#</span><span
style='color:#0070C0'>修改为<span lang=EN-US>false</span>，表示不自动挂载<span lang=EN-US>
secret</span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl apply -f qa-ns.yaml</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get sa -n qa</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='color:#0070C0;background:white'>修改<span
lang=EN-US> Pod </span>使用该<span lang=EN-US> ServiceAccount</span>：</span></p>

<p class=MsoNormal>先检查一下是否有这个<span lang=EN-US>pod</span>。</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get pod -n qa</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>注： 题目最后会给出<span lang=EN-US> pod yaml </span>路径，直接修改<span
lang=EN-US>yaml</span>里的<span lang=EN-US>SA</span>，<span lang=EN-US> apply </span>即可。</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vi /cks/sa/pod1.yaml</span></p>

<p class=MsoNormal>修改如下内容：</p>

<p class=MsoNormal><span lang=EN-US>apiVersion: v1</span></p>

<p class=MsoNormal><span lang=EN-US>kind: Pod</span></p>

<p class=MsoNormal><span lang=EN-US>metadata:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; name: backend</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; namespace: qa&nbsp;&nbsp; <span
style='color:#0070C0'>#</span></span><span style='color:#0070C0'>注意命名空间</span></p>

<p class=MsoNormal><span lang=EN-US>spec:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;
serviceAccountName: backend-sa&nbsp; </span><span lang=EN-US style='color:#0070C0'>&nbsp;#
</span><span style='color:#0070C0'>没有则添加，有则修改这一行为刚才创建的<span lang=EN-US>ServiceAccount</span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; containers:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; - image: nginx:1.9</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; imagePullPolicy:
IfNotPresent</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; name: backend</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl apply -f
/cks/sa/pod1.yaml</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get pod -n qa</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='color:#0070C0;background:white'>删除没有使用的<span
lang=EN-US> ServiceAccount</span>，即删除<span lang=EN-US>test01</span>：</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get sa -n qa</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl delete sa
test01 -n qa</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl delete sa
default -n qa</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>3</span>、默认网络策略<span lang=EN-US> default NetworkPolicy</span></h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>context</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>A
default-deny NetworkPolicy avoids to accidentally expose a Pod in a namespace
that doesn’t have any other NetworkPolicy defined.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>Task</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Create a
new default-deny NetworkPolicy named <span style='color:#0070C0'>denypolicy </span>in
the namespace <span style='color:#0070C0'>testing </span>for all traffic of
type <span style='color:#0070C0'>Ingress + Egress</span>.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>The new
NetworkPolicy must deny all <span style='color:#0070C0'>lngress + Egress </span>traffic
in the namespace <span style='color:#0070C0'>testing .</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Apply the
newly created default-deny NetworkPolicy to all Pods running in namespace <span
style='color:#0070C0'>testing</span> .</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>You can
find a skeleton manifest file</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>/cks/net/p1.yaml</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>内容：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'>默认的拒绝<span lang=EN-US>NetworkPolicy</span>可避免在未定义任何其他<span
lang=EN-US>NetworkPolicy</span>的命名空间中意外公开<span lang=EN-US>Pod</span>。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>解读：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'>在<span lang=EN-US> testing </span>命名空间创建一个名为<span
lang=EN-US> denypolicy </span>的网络策略。 </p>

<p class=MsoNormal style='border:none;padding:0cm'>在<span lang=EN-US>testing</span>命名空间中，拒绝所有<span
lang=EN-US> Ingress </span>和<span lang=EN-US>Egress </span>流量。 </p>

<p class=MsoNormal style='border:none;padding:0cm'>将网络策略应用到<span lang=EN-US>
testing </span>命名空间中的所有<span lang=EN-US> pod</span>。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>PS: </span>观察清楚题目要求，是默认拒绝所有，还是其他别的要求，根据题目要求来写<span
lang=EN-US>yaml</span>。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#%E9%BB%98%E8%AE%A4%E6%8B%92%E7%BB%9D%E6%89%80%E6%9C%89%E5%85%A5%E5%8F%A3%E5%92%8C%E6%89%80%E6%9C%89%E5%87%BA%E7%AB%99%E6%B5%81%E9%87%8F">https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#%E9%BB%98%E8%AE%A4%E6%8B%92%E7%BB%9D%E6%89%80%E6%9C%89%E5%85%A5%E5%8F%A3%E5%92%8C%E6%89%80%E6%9C%89%E5%87%BA%E7%AB%99%E6%B5%81%E9%87%8F</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1026 height=400
id="图片 10" src="CKS考试模拟题-2022-01-07.files/image012.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span lang=EN-US>&nbsp;</span></b></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSCS00101</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vi /cks/net/p1.yaml</span></p>

<p class=MsoNormal>修改为</p>

<p class=MsoNormal><span lang=EN-US>apiVersion: networking.k8s.io/v1</span></p>

<p class=MsoNormal><span lang=EN-US>kind: NetworkPolicy</span></p>

<p class=MsoNormal><span lang=EN-US>metadata:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; name:
denypolicy &nbsp;&nbsp;&nbsp;#</span><span style='color:#00B050'>修改<span
lang=EN-US>name</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; namespace:
testing&nbsp; </span><span lang=EN-US style='color:red'>&nbsp;#</span><span
style='color:red'>注意添加<span lang=EN-US>namespace</span></span></p>

<p class=MsoNormal><span lang=EN-US>spec:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; podSelector: {}</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; policyTypes:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; - Ingress&nbsp;&nbsp;&nbsp;
#</span><span style='color:#00B050'>注意看题，是<span lang=EN-US>Ingress + Egress</span>（入口<span
lang=EN-US>+</span>出口），还是只是<span lang=EN-US>Ingress</span>。</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; - Egress&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US style='color:red'>#</span><span style='color:red'>在<span
lang=EN-US>1.22</span>的考试中，只有<span lang=EN-US>Egress</span>。所以<span lang=EN-US>-
Ingress</span>就不用写了。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>创建</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl apply -f
/cks/net/p1.yaml</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>检查</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl describe
networkpolicy denypolicy -n testing</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=705 height=233
id="图片 13" src="CKS考试模拟题-2022-01-07.files/image013.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>4</span>、<span lang=EN-US>RBAC - RoleBinding</span></h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>context</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>A Role
bound to a Pod’s serviceAccount grants overly permissive permissions.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Complete
the following tasks to reduce the set of permissions.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>Task</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Given an
existing Pod named<span style='color:#0070C0'> web-pod</span> running in the
namespace <span style='color:#0070C0'>db</span>. </span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Edit the
existing Role bound to the Pod’s serviceAccount <span style='color:#0070C0'>service-account-web</span>
to only allow performing <span style='color:#0070C0'>get</span> operations,<b>
only</b> on resources of type <span style='color:#0070C0'>Endpoints</span>. </span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>create a
new Role named <span style='color:#0070C0'>role-2 </span>in the namespace <span
style='color:#0070C0'>db</span>, which <b>only</b> allows performing <span
style='color:#0070C0'>delete </span>operations, <b>only</b> on resources of
type <span style='color:#0070C0'>namespaces</span>.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>create a
new RoleBinding named <span style='color:#0070C0'>role-2-binding</span> binding
the newly created Role to the Pod’s serviceAccount.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Don’t
delete the existing RoleBinding.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>解读：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'>绑定到<span lang=EN-US>Pod</span>的<span
lang=EN-US>serviceAccount</span>的角色授予过度权限。</p>

<p class=MsoNormal style='border:none;padding:0cm'>完成以下任务以减少权限集。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1. </span>在<span
lang=EN-US> db </span>命名空间存在一个名为<span lang=EN-US> web-pod </span>的<span
lang=EN-US> Pod</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>2. </span>编辑该<span
lang=EN-US> Pod </span>绑定的 <span lang=EN-US>ServiceAccount service-account-web</span>的<span
lang=EN-US>Role</span>， 只允许对<span lang=EN-US> Endpoints </span>资源类型执行<span
lang=EN-US> get </span>操作</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>3. </span>在<span
lang=EN-US> db </span>命名空间创建一个名为<span lang=EN-US> role-2 </span>的<span
lang=EN-US> Role</span>，该角色只允许对<span lang=EN-US> namespaces </span>资源类型执行<span
lang=EN-US>delete </span>操作</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>4. </span>创建一个名为<span
lang=EN-US> role-2-binding </span>的<span lang=EN-US> <a name="_Hlk89342699">RoleBinding</a></span>，
绑定到<span lang=EN-US> ServiceAccount</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>5. </span>不要删除已经存在的<span
lang=EN-US> RoleBinding</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal>两个都要看</p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#role-and-clusterole">https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#role-and-clusterole</a></span></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7">https://kubernetes.io/zh/docs/reference/access-authn-authz/rbac/#%E4%B8%80%E4%BA%9B%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=987 height=463
id="图片 16" src="CKS考试模拟题-2022-01-07.files/image014.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSCH00201</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>注： 不要删除已经存在的<span lang=EN-US> RoleBinding</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>查看<span lang=EN-US>ServiceAccount &nbsp;service-account-web</span>对应的<span
lang=EN-US>rolebindings role-1-binding</span></p>

<p class=MsoNormal>查看<span lang=EN-US>rolebindings role-1-binding</span>对应的<span
lang=EN-US>role</span>为<span lang=EN-US>role-1</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl describe
rolebindings -n db</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=430 height=200
id="图片 15" src="CKS考试模拟题-2022-01-07.files/image015.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>编辑<span lang=EN-US>role-1</span>权限：</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl edit role role-1
-n db</span></p>

<p class=MsoNormal>修改如下内容</p>

<p class=MsoNormal><span lang=EN-US>apiVersion: rbac.authorization.k8s.io/v1</span></p>

<p class=MsoNormal><span lang=EN-US>kind: Role</span></p>

<p class=MsoNormal><span lang=EN-US>metadata:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; annotations:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;
kubectl.kubernetes.io/last-applied-configuration: |</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
{&quot;apiVersion&quot;:&quot;rbac.authorization.k8s.io/v1&quot;,&quot;kind&quot;:&quot;Role&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;name&quot;:&quot;role-1&quot;,&quot;namespace&quot;:&quot;db&quot;}}</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; creationTimestamp:
&quot;2021-11-23T16:38:54Z&quot;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; name: role-1</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; namespace: db</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; resourceVersion: &quot;30867&quot;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; uid:
22e3c185-f7f5-4542-b86a-6ce153aa1c5a</span></p>

<p class=MsoNormal><span lang=EN-US>rules: <span style='color:#00B050'>#</span></span><span
style='color:#00B050'>删除<span lang=EN-US>null</span>，添加如下内容</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>- apiGroups:
[&quot;&quot;] </span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; resources:
[&quot;endpoints&quot;]&nbsp;&nbsp;&nbsp; #</span><span style='color:#00B050'>只允许对<span
lang=EN-US> Endpoints </span>资源类型执行<span lang=EN-US> get </span>操作。还有可能会考只允许对<span
lang=EN-US>endpoints</span>资源<span lang=EN-US>list</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; verbs:
[&quot;get&quot;]</span></p>

<p class=MsoNormal>要学会举一反三，中文考题里会问，仅允许只对<span lang=EN-US>services</span>类型的资源执行<span
lang=EN-US>list</span>操作，这里你就要写<span lang=EN-US>services</span>和<span
lang=EN-US>list</span>。</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>检查</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl describe role
role-1 -n db</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=438 height=146
id="图片 17" src="CKS考试模拟题-2022-01-07.files/image016.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>在<span lang=EN-US>db</span>命名空间，创建名为<span lang=EN-US>role-2</span>的<span
lang=EN-US>role</span>，并且通过<span lang=EN-US>rolebinding</span>绑定<span
lang=EN-US>service-account-web</span>，只允许对<span lang=EN-US>namespaces</span>做<span
lang=EN-US>delete</span>操作。</p>

<p class=MsoNormal>记住<span lang=EN-US> --verb</span>是权限<span lang=EN-US>
--resource</span>是对象</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl create role
role-2 </span><span lang=EN-US style='color:red'>--verb=delete</span><span
lang=EN-US> <span style='color:red'>--resource=namespaces</span><span
style='color:#C45911'> -n db</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl create
rolebinding role-2-binding </span><span lang=EN-US style='color:red'>--role=role-2
--serviceaccount=db:service-account-web </span><span lang=EN-US
style='color:#C45911'>-n db</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>检查</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl describe
rolebindings -n db</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=457 height=392
id="图片 18" src="CKS考试模拟题-2022-01-07.files/image017.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'>另一个问法</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Given an
existing Pod named web-pod running in the namespace monitoring. </span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Edit the
existing Role bound to the Pod’s serviceAccount sa-dev-1 to only allow performing
list operations, only on resources of type Endpoints.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>create a
new Role named role-2 in the namespace monitoring, which only allows performing
<span style='color:#0070C0'>update </span>operations, only on resources of type
<span style='color:#0070C0'>persistentvolumeclaims</span><span
style='color:#00B0F0'>.</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>create a
new RoleBinding named role-2-binding binding the newly created Role to the
Pod’s serviceAccount.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Don’t
delete the existing RoleBinding.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#C45911'>kubectl create role role-2
--resource=persistentvolumeclaims --verb=update -n monitoring</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#C45911'>kubectl create rolebinding role-2-binding --role=role-2
--serviceaccount=monitoring:sa-dev-1&nbsp; -n monitoring</span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>5</span>、日志审计 <span lang=EN-US>log audit</span></h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>Task</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Enable
audit logs in the cluster.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>To do so,
enable the log backend, and ensurethat:</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&gt;logs
are stored at<span style='color:#0070C0'> /var/log/kubernetes/audit-logs.txt</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&gt;log
files are retained for <span style='color:#0070C0'>10</span> days</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&gt;at
maximum, a number of <span style='color:#0070C0'>2 </span>old audit log files
are retained</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>A basic
policy is provided at<span style='color:#0070C0'>
/etc/kubernetes/logpolicy/sample-policy.yaml </span>. it only specifies what <b>not</b>
to log.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:red'>The base policy is located on thecluster’s master node.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Edit and
extend the basic policy to log:</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&gt;<span
style='color:#0070C0'>namespaces</span> changes at RequestResponse level</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&gt;the
request body of <span style='color:#0070C0'>persistentvolumes </span>changes in
the namespace <span style='color:#0070C0'>front-apps</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&gt;ConfigMap
and secret changes in all namespaces at the <span style='color:#0070C0'>Metadata
</span>level</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Also, add a
catch-all ruie to log all other requests at the <span style='color:#0070C0'>Metadata
</span>level.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Don’t
forget to apply the modifiedpolicy.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>解读：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'>在集群启用审计，并确保：</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&gt;</span>日志路径为<span
lang=EN-US> /var/log/kubernetes/audit-logs.txt</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&gt;</span>日志文件保留<span
lang=EN-US> 10 </span>天</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&gt;</span>最多保留<span
lang=EN-US> 2 </span>个日志文件</p>

<p class=MsoNormal style='border:none;padding:0cm'>基本策略在<span lang=EN-US>/etc/kubernetes/logpolicy/sample-policy.yaml
</span>文件中提供（该文件在<span lang=EN-US> master </span>节点上）， 它指定了不记录的日志内容。</p>

<p class=MsoNormal style='border:none;padding:0cm'>编辑和扩展基本策略到日志：</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&gt;</span>命名空间在<span
lang=EN-US> RequestResponse </span>级别更改</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&gt;PV </span>的请求内容在<span
lang=EN-US> front-apps </span>命名空间发生了更改</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&gt;Configmap
</span>和<span lang=EN-US> secret </span>在所有命名空间<a name="_Hlk89295707"><span
lang=EN-US> Metadata </span>级别</a>更改</p>

<p class=MsoNormal style='border:none;padding:0cm'>另外，添加一个<span lang=EN-US>catch-all</span>来记录在<span
lang=EN-US>Metadata </span>级别的所有请求。</p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal>两个都要看</p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/#audit-policy">https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/#audit-policy</a></span></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/#log-%E5%90%8E%E7%AB%AF">https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/#log-%E5%90%8E%E7%AB%AF</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=902 height=534
id="图片 20" src="CKS考试模拟题-2022-01-07.files/image018.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1027 height=845
id="图片 8" src="CKS考试模拟题-2022-01-07.files/image019.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span lang=EN-US>&nbsp;</span></b></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSCH00601</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>本题分数比较多，占<span lang=EN-US>12%</span>。</p>

<p class=MsoNormal>日志审计这一题需要自己调整的内容还是挺多的，因此要非常仔细，建议修改前备份一下原始的环境，要不然修改错了就会导致集群崩溃。</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>需要从控制台<span lang=EN-US>ssh</span>到<span lang=EN-US>master</span>节点，</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>ssh root@master01</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>配置审计策略</p>

<p class=MsoNormal>先备份陪孩子文件</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>mkdir bak6</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>cp /etc/kubernetes/logpolicy/sample-policy.yaml&nbsp;
bak6/</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vim /etc/kubernetes/logpolicy/sample-policy.yaml</span></p>

<p class=MsoNormal>参考官方网址内容</p>

<p class=MsoNormal><span lang=EN-US>apiVersion: audit.k8s.io/v1</span></p>

<p class=MsoNormal><span lang=EN-US>kind: Policy</span></p>

<p class=MsoNormal><span lang=EN-US># Don't generate audit events for all
requests in RequestReceived stage.</span></p>

<p class=MsoNormal><span lang=EN-US>omitStages:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; - &quot;RequestReceived&quot;</span></p>

<p class=MsoNormal><span lang=EN-US>rules:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; # namespaces changes at
RequestResponse level</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; - level:
RequestResponse&nbsp; </span><span lang=EN-US style='color:#0070C0'>&nbsp;#</span><span
style='color:#0070C0'>根据题目要求，参考官网，编辑如下内容。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; resources:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; - group: &quot;&quot;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
resources: [&quot;namespaces&quot;]</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; #the request body of persistentvolumes/pods
changes in the namespace front-apps</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; - level: Request</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; resources:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; - group: &quot;&quot;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
resources: [&quot;persistentvolumes&quot;]&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='color:#0070C0'>#</span><span style='color:#0070C0'>这里有可能还会考<span
lang=EN-US>pods</span>或其他，比如考<span lang=EN-US>pods</span>，你就将<span lang=EN-US>persistentvolumes</span>换成<span
lang=EN-US>pods</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;
namespaces: [&quot;front-apps&quot;]</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; # Log configmap and secret changes
in all other namespaces at the Metadata level.</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; - level:
Metadata</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; resources:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; - group: &quot;&quot;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
resources: [&quot;secrets&quot;, &quot;configmaps&quot;]</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; # Also, add a catch-all rule to log
all other requests at the Metadata level.</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; - level:
Metadata</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; omitStages:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
- &quot;RequestReceived&quot;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>编辑<span lang=EN-US> master </span>节点的<span lang=EN-US>kube-apiserver.yaml</span></p>

<p class=MsoNormal>先备份陪孩子文件</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>mkdir bak6</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>cp /etc/kubernetes/manifests/kube-apiserver.yaml&nbsp;
bak6/</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vi
/etc/kubernetes/manifests/kube-apiserver.yaml</span></p>

<p class=MsoNormal>添加以下参数：</p>

<p class=MsoNormal><span lang=EN-US>#</span>定义审计策略<span lang=EN-US>yaml</span>文件位置，通过<span
lang=EN-US>hostpath</span>挂载</p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp; -
--audit-policy-file=/etc/kubernetes/logpolicy/sample-policy.yaml&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US style='color:#0070C0'>#</span><span style='color:#0070C0'>注意前面是<span
lang=EN-US>- -- </span>，而且后面没有带<span lang=EN-US>\</span></span></p>

<p class=MsoNormal><span lang=EN-US>#</span>定义审计日志位置，通过<span lang=EN-US>hostpath</span>挂载</p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp; - --audit-log-path=/var/log/kubernetes/audit-logs.txt</span></p>

<p class=MsoNormal><span lang=EN-US>#</span>定义保留旧审计日志文件的最大天数为<span lang=EN-US>10</span>天</p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp; -
--audit-log-maxage=10</span></p>

<p class=MsoNormal><span lang=EN-US>#</span>定义要保留的审计日志文件的最大数量为<span lang=EN-US>2</span>个</p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp; -
--audit-log-maxbackup=2</span></p>

<p class=MsoNormal><span lang=EN-US>#</span>在<span lang=EN-US>kube-apiserver.yaml
</span>文件的<span lang=EN-US>volumeMounts </span>标签下增加</p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp;
volumeMounts:&nbsp;&nbsp; #</span><span style='color:#0070C0'>找到这个字段，添加下面内容</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp; -
mountPath: </span><span lang=EN-US style='color:red'>/etc/kubernetes/logpolicy/sample-policy.yaml</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
name: audit&nbsp;&nbsp; </span><span lang=EN-US style='color:red'>#</span><span
style='color:red'>注意，在<span lang=EN-US>1.22</span>考试中，蓝色的内容已经有了，你只需要添加绿色字体的内容。可以通过红色字，在文件中定位。但模拟环境没有加，需要你全部手动添加。这样是为了练习，万一考试中没有，你也会加。但是如果考试中已添加，你再添加一遍，则会报错，导致<span
lang=EN-US>api-server</span>启不起来。</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
readOnly: true&nbsp;&nbsp;&nbsp;&nbsp; #</span><span style='color:#00B050'>这个为<span
lang=EN-US>true</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp; -
mountPath: </span><span lang=EN-US style='color:red'>/var/log/kubernetes/</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
name: audit-log&nbsp;&nbsp;&nbsp; </span><span lang=EN-US style='color:red'>#</span><span
style='color:red'>注意，在<span lang=EN-US>1.22</span>考试中，蓝色的内容已经有了，你只需要添加绿色字体的内容。可以通过红色字，在文件中定位。但模拟环境没有加，需要你全部手动添加。这样是为了练习，万一考试中没有，你也会加。</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
readOnly: false&nbsp;&nbsp;&nbsp;&nbsp; #</span><span style='color:#00B050'>这个为<span
lang=EN-US>false</span></span></p>

<p class=MsoNormal><span lang=EN-US>#</span>在<span lang=EN-US>kube-apiserver.yaml
</span>文件的<span lang=EN-US>volumes</span>标签下增加</p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp; volumes:&nbsp;&nbsp;&nbsp;
#</span><span style='color:#0070C0'>找到这个字段，添加下面内容 <span lang=EN-US>&nbsp;&nbsp;</span></span><span
lang=EN-US style='color:red'>#</span><span style='color:red'>注意，在<span
lang=EN-US>1.22</span>考试中，蓝色的内容已经有了，<span lang=EN-US>volumes</span>这段无需修改，但是为了以防万一，模拟环境中没有加，需要你手动添加。这样是为了练习，万一考试中没有，你也会加。</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp; - name: audit</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp;
hostPath:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
path: </span><span lang=EN-US style='color:red'>/etc/kubernetes/logpolicy/sample-policy.yaml</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
type: File</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp; - name:
audit-log</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp;
hostPath:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
path: </span><a name="_Hlk91614280"><span lang=EN-US style='color:red'>/var/log/kubernetes/</span></a></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
type: DirectoryOrCreate</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>重启<span lang=EN-US>kubelet</span>服务</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>systemctl restart
kubelet</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>等待<span lang=EN-US>2</span>分钟后，再检查</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get pod -A</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>tail
/var/log/kubernetes/audit-logs.txt</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=873 height=463
id="图片 24" src="CKS考试模拟题-2022-01-07.files/image020.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=669 height=580
id="图片 22" src="CKS考试模拟题-2022-01-07.files/image021.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=486 height=744
id="图片 21" src="CKS考试模拟题-2022-01-07.files/image022.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>type</span>：</p>

<p class=MsoNormal><span lang=EN-US>DirectoryOrCreate&nbsp; </span>宿主机上不存在创建此目录<span
lang=EN-US>&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>Directory </span>必须存在挂载目录<span lang=EN-US>&nbsp;
</span></p>

<p class=MsoNormal><span lang=EN-US>FileOrCreate </span>宿主机上不存在挂载文件就创建<span
lang=EN-US>&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>File </span>必须存在文件<span lang=EN-US>&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>vim</span>多行插入的方法：（具体可以百度一下）</p>

<p class=MsoNormal><span lang=EN-US>vim </span>文件名</p>

<p class=MsoNormal><span lang=EN-US>ctrl + v &nbsp;</span>上下箭头选中所要添加<span
lang=EN-US>#</span>的行</p>

<p class=MsoNormal><span lang=EN-US>shift + I </span>或者大写<span lang=EN-US>I &nbsp;</span>添加内容，比如按两个空格</p>

<p class=MsoNormal>按<span lang=EN-US>esc</span>，刚才选中的行，都会自动插入两个空格。</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>6</span>、创建<span lang=EN-US> Secret</span></h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>Task</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Retrieve
the content of the existing secret named <span style='color:#0070C0'>db1-test</span>
in the<span style='color:#0070C0'> istio-system</span> namespace.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>store the <span
style='color:#0070C0'>username </span>field in a file named <a
name="_Hlk88664467"></a><a name="_Hlk88664615"><span style='color:#0070C0'>/cks/sec</span></a><span
style='color:#0070C0'>/user.txt</span><span style='color:#0070C0'> &nbsp;</span>,
and the <span style='color:#0070C0'>password </span>field in a file named <span
style='color:#0070C0'>/cks/sec/pass.txt</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:red;background:#D9D9D9'>You must create both files; they don exist
yet.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#ED7D31'>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#ED7D31'>Do not use/modify the created files in the following
steps, create new temporary files if needed.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Create a
new secret named <span style='color:#0070C0'>db2-test</span> in the <span
style='color:#0070C0'>istio-system </span>namespace, with the following
content:</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><a name="_Hlk88664527"><span
lang=EN-US style='color:#0070C0'>username : &nbsp;production-instance</span></a></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>password : &nbsp;KvLftKgs4aVH</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Finally,
create a new Pod that has access to the secret <a name="_Hlk88664554"><span
style='color:#0070C0'>db2-test</span></a><span style='color:#0070C0'> </span>via
a volume:</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>pod name &nbsp;<span
style='color:#0070C0'>secret-pod</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>namespace &nbsp;<span
style='color:#0070C0'>istio-system</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>container
name &nbsp;<span style='color:#0070C0'>&nbsp;dev-container</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>image &nbsp;<span
style='color:#0070C0'>nginx</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>volume name
&nbsp;<span style='color:#0070C0'>secret-volume</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>mount path <span
style='color:#0070C0'>&nbsp;&nbsp;/etc/secret</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>解读：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'>在<span lang=EN-US>
istio-system </span>命名空间存在一个名为<span lang=EN-US> db1-test </span>的<span
lang=EN-US> secret</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>将<span lang=EN-US> username </span>字段保存到文件名为<span
lang=EN-US>/cks/sec/user.txt </span>，<span lang=EN-US> password </span>字段保存到文件名为<span
lang=EN-US>/cks/sec/pass.txt</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>注意：您必须创建这两个文件；它们还不存在。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>注意：不要在以下步骤中使用<span
lang=EN-US>/</span>修改创建的文件，如果需要，请创建新的临时文件。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>在<span lang=EN-US>
istio-system </span>命名空间创建一个名为<span lang=EN-US> <a name="_Hlk89296507">db2-test</a>
</span>的<span lang=EN-US> secret</span>， 内容如下：</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>username : production-instance</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>password : KvLftKgs4aVH</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>最后， 创建一个新的<span lang=EN-US>
Pod db2-test </span>，可以通过<span lang=EN-US> volume </span>方式访问<span lang=EN-US>
secret </span>内容。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal>三个网址都要看</p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#decoding-secret">https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#decoding-secret</a></span></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#create-a-secret">https://kubernetes.io/zh/docs/tasks/configmap-secret/managing-secret-using-kubectl/#create-a-secret</a></span></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets">https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=810 height=476
id="图片 30" src="CKS考试模拟题-2022-01-07.files/image023.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=899 height=438
id="图片 66" src="CKS考试模拟题-2022-01-07.files/image024.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=802 height=609
id="图片 28" src="CKS考试模拟题-2022-01-07.files/image025.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSCH00701</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>将<span lang=EN-US>db1-test</span>的<span lang=EN-US>username</span>和<span
lang=EN-US>password</span>，通过<span lang=EN-US>base64</span>解码保存到题目指定文件：</p>

<p class=MsoNormal><b>方法<span lang=EN-US>1</span>：</b></p>

<p class=MsoNormal><span lang=EN-US>kubectl get secrets db1-test -n
istio-system -o jsonpath={.data}</span></p>

<p class=MsoNormal>会反馈结果为：<span lang=EN-US>{&quot;password&quot;:&quot;aGVsbG8=&quot;,&quot;username&quot;:&quot;ZGIx&quot;}</span></p>

<p class=MsoNormal><span lang=EN-US>echo 'ZGIx'|base64 -d &gt;&nbsp;
/cks/sec/user.txt</span></p>

<p class=MsoNormal><span lang=EN-US>echo 'aGVsbG8='|base64 -d &gt;&nbsp;
/cks/sec/pass.txt</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>方法<span lang=EN-US>2</span>：</b></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get secrets
-n istio-system db1-test -o jsonpath={.data.username} | base64 -d &gt;&nbsp;
/cks/sec/user.txt</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get secrets
-n istio-system db1-test -o jsonpath={.data.password} | base64 -d &gt;&nbsp;
/cks/sec/pass.txt</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>检查</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>cat /cks/sec/user.txt</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>cat /cks/sec/pass.txt</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=386 height=54 id="图片 27"
src="CKS考试模拟题-2022-01-07.files/image026.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>创建名为 <span lang=EN-US>db2-test </span>的<span lang=EN-US>
secret </span>使用题目要求的用户名和密码作为键值。<span style='color:red'>注意要加命名空间。</span></p>

<p class=MsoNormal><span style='color:red'>注意，如果密码中有特殊字符（例如：<span lang=EN-US>$</span>，<span
lang=EN-US>\</span>，<span lang=EN-US>*</span>，<span lang=EN-US>= </span>和<span
lang=EN-US> !</span>），需要加单引号来转义<span lang=EN-US>--from-literal=password='G!Y\*d$zDsb'</span>这样。</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl create secret
generic db2-test </span><span lang=EN-US style='color:red'>-n istio-system</span><span
lang=EN-US style='color:#C45911'> --from-literal=username=production-instance
--from-literal=password=KvLftKgs4aVH</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>检查</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get secret -n
istio-system</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>根据题目要求，参考官网，创建<span lang=EN-US>Pod</span>使用该<span
lang=EN-US>secret</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vim k8s-secret.yaml</span></p>

<p class=MsoNormal>添加如下内容</p>

<p class=MsoNormal><span lang=EN-US>apiVersion: v1</span></p>

<p class=MsoNormal><span lang=EN-US>kind: Pod</span></p>

<p class=MsoNormal><span lang=EN-US>metadata:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; name:
secret-pod&nbsp;&nbsp; #pod</span><span style='color:#00B050'>名字</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; namespace:
istio-system&nbsp;&nbsp; #</span><span style='color:#00B050'>命名空间</span></p>

<p class=MsoNormal><span lang=EN-US>spec:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; containers:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; - name:
dev-container&nbsp;&nbsp; #</span><span style='color:#00B050'>容器名字</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;
image: nginx&nbsp;&nbsp;&nbsp; #</span><span style='color:#00B050'>镜像名字</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;
volumeMounts:&nbsp;&nbsp; #</span><span style='color:#00B050'>挂载路径</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp; -
name: </span><span lang=EN-US style='color:#0070C0'>secret-volume&nbsp; </span><span
lang=EN-US style='color:#00B050'>#</span><span style='color:#00B050'>卷名</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
mountPath: /etc/secret</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; volumes:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; - name: </span><span
lang=EN-US style='color:#0070C0'>secret-volume</span><span lang=EN-US
style='color:#00B050'>&nbsp; #</span><span style='color:#00B050'>卷名</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;
secret:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
secretName: db2-test&nbsp;&nbsp; #</span><span style='color:#00B050'>名为<span
lang=EN-US> db2-test </span>的<span lang=EN-US> secret</span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>创建</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl apply -f
k8s-secret.yaml</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>检查</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get pod -n
istio-system</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=405 height=70 id="图片 26"
src="CKS考试模拟题-2022-01-07.files/image027.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>7</span>、<a name="_Hlk91617463"><span lang=EN-US>Dockerfile</span>检测</a></h1>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><b><span
lang=EN-US>Task</span></b></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>Analyze and edit the given Dockerfile &nbsp;(based on the <span
style='color:#0070C0'>ubuntu:16.04</span> image) <span style='color:#0070C0'>&nbsp;<a
name="_Hlk88674343">/cks/docker/Dockerfile</a></span> , fixing <b>two
instructions</b> present in the file being prominent security/best-practice
issues.</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>Analyze and edit the given manifest file <a name="_Hlk88674358">&nbsp;<span
style='color:#0070C0'>/cks/docker/deployment.yaml </span></a><span
style='color:#0070C0'>&nbsp;</span>fixing <b>two fields </b>present in the file
being prominent security/best-practice issues.</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US style='color:red'>Don't add or remove configuration settings; only modify
the existing configuration settings, </span><span lang=EN-US>so that <b>two</b>
configuration settings each are no longer security/best-practice concerns</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>Should you need an unprivileged user for any of the tasks , use user
<span style='color:#0070C0'>nobody </span>with user id <span style='color:#0070C0'>65535</span></span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><b>解读：</b></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&#61548; </span>分析和编辑给定的<span lang=EN-US> Dockerfile</span>（基于<span
lang=EN-US> Ubuntu:16.04 </span>镜像）<span lang=EN-US>/cks/docker/Dockerfile</span>，修复文件中两处存在安全性和最佳实践问题。</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&#61548; </span>分析和编辑给定的<span lang=EN-US> YAML </span>清单文件<span lang=EN-US>/cks/docker/deployment.yaml</span>，
修复文件中两处存在安全性和最佳实践问题。</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>不要添加或删除配置设置：只修改现有的配置设置，这样两个配置设置不再是安全<span
lang=EN-US>/</span>最佳做法问题</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>如果您需要任何任务的非特权用户，请使用用户<span
lang=EN-US>id</span>为<span lang=EN-US>65535</span>的用户<span lang=EN-US>nobody</span></p>

</div>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/security-context/#set-capabilities-for-a-container">https://kubernetes.io/zh/docs/tasks/configure-pod-container/security-context/#set-capabilities-for-a-container</a></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=1026 height=545 id="图片 67"
src="CKS考试模拟题-2022-01-07.files/image028.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSSC00301</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>注意题目中提示的错误数量，这里每个文件各有<span
lang=EN-US>2</span>个错误。</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>vi /cks/docker/Dockerfile</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='color:red'>将两处<span
lang=EN-US>USER root</span>注释掉（不要删除，而是注释掉即可），考试时也可能是一处<span lang=EN-US>USER root</span>。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#00B050'># USER root</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='color:red'>设置基础镜像为<span
lang=EN-US> ubuntu:16.04</span></span></p>

<p class=MsoNormal align=left style='text-align:left'>修改<span lang=EN-US>ubuntu:16.04</span>为</p>

<p class=MsoNormal align=left style='text-align:left'><span style='color:red'>模拟环境里的基础镜像已经写对了，但是在<span
lang=EN-US>1.22</span>的考试中，这里错误的写成了<span lang=EN-US>ubuntu:laste</span>。所以，你要根据题目要求，换成正确的镜像文件！</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#00B050'>FROM ubuntu:16.04</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>vi /cks/docker/deployment.yaml</span></p>

<p class=MsoNormal align=left style='text-align:left'>修改<span lang=EN-US>apiVersion</span>。考试时，这里可能会有错误，你需要检查一下，是否为<span
lang=EN-US>apiVersion: apps/v1</span>或者<span lang=EN-US>apiVersion: v1</span>都行。</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#00B050'>apiVersion: <a name="_Hlk88677648">apps/v1</a></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='color:red'>注释下面两行（不要删除，而是注释）。注意，考试时，下面两行也可能会写成了一行，所以这里只需要记住注释的是<span
lang=EN-US>securityContext: 'privileged'</span>。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#00B050'># securityContext:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#00B050'># {&quot;Capabilities&quot;: {'add':{NET_BIND_SERVICE},
'drop: []'}, <a name="_Hlk89960741">'privileged'</a>: TRUE}</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>8</span>、沙箱运行容器<span lang=EN-US> gVisor</span></h1>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><b><span
lang=EN-US>context</span></b></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>This cluster uses <span style='color:#0070C0'>containerd </span>as
CRl runtime.</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>Containerd default runtime handler is <span style='color:#0070C0'>runc</span>
.</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>Containerd has been prepared to support an additional runtime
handler , <span style='color:#0070C0'>runsc </span>(gVisor).</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><b><span
lang=EN-US>Task</span></b></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>Create a RuntimeClass named <span style='color:#0070C0'>untrusted </span>using
the prepared runtime handler named <span style='color:#0070C0'>runsc</span> .</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>Update <span style='color:red'>all Pods</span> in the namespace <span
style='color:#0070C0'>server </span>to run on gvisor, unless they are already
running on anon-default runtime handler. </span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>（这里再加一条，将<span
lang=EN-US>server </span>命名空间中的所有<span lang=EN-US> Pod</span>和<span lang=EN-US>deployment</span>都使其在<span
lang=EN-US>gVisor</span>上运行）</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>You can find a skeleton manifest file at <span style='color:#0070C0'>/cks/gVisor/rc.yaml</span></span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><b>内容：</b></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>这个集群使用<span
lang=EN-US> containerd </span>作为<span lang=EN-US> CRI </span>运行时。 </p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>Containerd </span>的默认运行时处理程序是<span lang=EN-US>runc</span>，</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>Containerd </span>也支持额外的运行时处理程序<span lang=EN-US> runsc</span>（<span
lang=EN-US>gVisor</span>）</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><b>解读：</b></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>创建一个名为<span
lang=EN-US> untrusted </span>的<span lang=EN-US> RuntimeClass</span>， 使用准备好的运行时处理程序<span
lang=EN-US> runsc</span>。</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>更新<span
lang=EN-US> server </span>命名空间中的所有<span lang=EN-US> Pod </span>使其在<span
lang=EN-US> gVisor </span>上运行。</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>您可以在<span
lang=EN-US>/cks/gVisor/rc.yaml</span>中找到骨架清单文件。</p>

</div>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/concepts/containers/runtime-class/#2-%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%BA%94%E7%9A%84-runtimeclass-%E8%B5%84%E6%BA%90">https://kubernetes.io/zh/docs/concepts/containers/runtime-class/#2-%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%BA%94%E7%9A%84-runtimeclass-%E8%B5%84%E6%BA%90</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1027 height=743
id="图片 68" src="CKS考试模拟题-2022-01-07.files/image029.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSMV00301</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>用官网文档创建一个<span
lang=EN-US>runtimeclass</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>vi /cks/gVisor/rc.yaml</span></p>

<p class=MsoNormal align=left style='text-align:left'>添加如下内容</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>apiVersion:
node.k8s.io/v1beta1</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>kind:
RuntimeClass</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>metadata:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#00B050'>&nbsp; name: untrusted &nbsp;&nbsp;# </span><span
style='color:#00B050'>用来引用<span lang=EN-US> RuntimeClass </span>的名字，<span
lang=EN-US>RuntimeClass </span>是一个集群层面的资源</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#00B050'>handler: runsc &nbsp;&nbsp;# </span><span
style='color:#00B050'>对应的<span lang=EN-US> CRI </span>配置的名称</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>创建</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>kubectl apply -f /cks/gVisor/rc.yaml</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>检查</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>kubectl get RuntimeClass</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=714 height=119 id="图片 34"
src="CKS考试模拟题-2022-01-07.files/image030.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>将<span lang=EN-US>server </span>命名空间中的<span
style='color:red'>所有<span lang=EN-US> Pod</span>和<span lang=EN-US>deployment</span></span>都使其在<span
lang=EN-US>gVisor</span>上运行</p>

<p class=MsoNormal align=left style='text-align:left'><span style='color:red'>注意题目要求，是要你修改的是所有<span
lang=EN-US>pod</span>，还是所有<span lang=EN-US>deployment</span>。如果没有指明，你要将所有的<span
lang=EN-US>deployment</span>和<span lang=EN-US>pod</span>都修改。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='color:red'>我这里的模拟环境，是<span
lang=EN-US>1</span>个<span lang=EN-US>deployment</span>，<span lang=EN-US>2</span>个<span
lang=EN-US>pod</span>要改。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='color:#0070C0'>（考试时，先查<span
lang=EN-US>deployment</span>，如果有<span lang=EN-US>deployment</span>，则修改<span
lang=EN-US>deployment</span>。然后再查<span lang=EN-US>pod</span>，有单独的<span
lang=EN-US>pod</span>的话，也要修改。通过<span lang=EN-US>kubectl edit</span>修改）</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>kubectl get all -n server</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=584 height=195 id="图片 35"
src="CKS考试模拟题-2022-01-07.files/image031.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>编辑<span lang=EN-US>deployment </span>（<span
style='color:red'>这里环境有点问题，没有安装<span lang=EN-US>runsc</span>，所以改完后保存会报错，忽略吧，先模拟一下命令即可。</span>）</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>kubectl edit deployments nginx-host -n server</span></p>

<p class=MsoNormal align=left style='text-align:left'>修改如下内容</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
spec:&nbsp;&nbsp; #</span>找到这个<span lang=EN-US>spec</span>，注意在<span lang=EN-US>deployment</span>里是有两个<span
lang=EN-US>spec</span>的，要找第二个，<span style='color:red'>也就是下面有<span lang=EN-US>containers</span>这个字段的。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#0070C0'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; runtimeClassName:
untrusted</span><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp; #</span><span
style='color:#00B050'>添加这一行，注意空格对齐，保存会报错，忽略即可。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#7030A0'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a name="_Hlk88683603">containers</a>:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
- image: vicuu/nginx:host</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
imagePullPolicy: IfNotPresent</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
name: nginx-host</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>编辑<span lang=EN-US>pod</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>kubectl edit pod nginx-gvisor -n server</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>spec:&nbsp;
#</span>在<span lang=EN-US>pod</span>里，只有一个<span lang=EN-US>spec</span>，选择这个<span
lang=EN-US>spec</span>下面添加。</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#0070C0'>&nbsp; runtimeClassName: untrusted</span><span
lang=EN-US style='color:#00B0F0'> </span><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span
style='color:#00B050'>添加这一行，注意空格对齐，保存会报错，忽略即可。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#7030A0'>&nbsp; containers:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp; -
image: nginx</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
imagePullPolicy: IfNotPresent</span></p>

<p class=MsoNormal align=left style='text-align:left;text-indent:21.0pt'><span
lang=EN-US>name: nginx-gvisor</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>编辑<span lang=EN-US>pod</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>kubectl edit pod busybox -n server</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>spec:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#0070C0'>&nbsp; runtimeClassName: untrusted </span><span
lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span
style='color:#00B050'>添加这一行，注意空格对齐，保存会报错，忽略即可。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#7030A0'>&nbsp; containers:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp; -
args:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
- /bin/sh</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
- -c</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
- |</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
i=0; while true; do</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
echo &quot;$(date) INFO $i&quot; &gt;&gt; /var/log/11-factor-app.log;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
i=$((i+1));</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
sleep 1;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
done</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
image: busybox</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
imagePullPolicy: IfNotPresent</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
name: busybox</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>9</span>、删除非无状态和启用特权的<span lang=EN-US> Pod</span></h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>context</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>lt is
best-practice to design containers to best teless and immutable.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>Task</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>lnspect
Pods running in namespace <a name="_Hlk88745837"><span style='color:#0070C0'>production
</span></a>and delete any Pod that is either<b> not stateless</b> or <b>not
immutable</b>.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Use the
following strict interpretation of stateless and immutable:</span></p>

<p class=MsoNormal style='text-indent:5.25pt;border:none;padding:0cm'><span
lang=EN-US>&gt;Pods being able to store data inside containers must be treated
as <b>not stateless.</b></span></p>

<p class=MsoNormal style='text-indent:15.75pt;border:none;padding:0cm'><span
lang=EN-US>You don’t have to worry whether data is actually stored inside
containers or not already.</span></p>

<p class=MsoNormal style='text-indent:5.25pt;border:none;padding:0cm'><span
lang=EN-US>&gt;Pods being configured to be privileged in any way must be
treated as potentially <b>not stateless</b> and <b>not immutable.</b></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>内容：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'>最好的做法是将容器设计成最佳的远程和不变的。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>解读： </b></p>

<p class=MsoNormal style='border:none;padding:0cm'>检查在<span lang=EN-US>
production </span>命名空间运行的<span lang=EN-US> Pod</span>，并删除任何 非无状态（有状态） 或非不可变（可变）
的<span lang=EN-US> Pod</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>以下是对无状态和不可变的解释：</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&#61548; </span>在容器中存储数据的<span
lang=EN-US> Pod </span>视为非无状态</p>

<p class=MsoNormal style='text-indent:10.5pt;border:none;padding:0cm'>（您不必担心数据是否实际存储在容器中。）</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&#61548; </span>启用特权的<span
lang=EN-US> Pod </span>都视为潜在的非无状态和非不可变</p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">https://kubernetes.io/docs/tasks/configure-pod-container/security-context/</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1027 height=572
id="图片 2" src="CKS考试模拟题-2022-01-07.files/image032.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSRS00501</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>查看此命名空间下的所有<span lang=EN-US> pod</span>，删除有特权 <span
lang=EN-US>Privileged </span>或者挂载<span lang=EN-US> volume </span>的<span
lang=EN-US> pod</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get pod -n
production</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get pods XXXX
-n production -o yaml | grep -i &quot;privileged: true&quot;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US style='color:#0070C0'>#</span><span style='color:#0070C0'>注意冒号后面有一个空格，<span
lang=EN-US>XXXX</span>换成<span lang=EN-US>production</span>命名空间下的<span
lang=EN-US>pod</span>名。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>将上面查出来的有特权的<span lang=EN-US>pod</span>删除</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl delete pod
XXXX -n production</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>上面只是将特权的<span lang=EN-US>pod</span>查出来了，根据题目要求，还应该查挂载<span
lang=EN-US>volume</span>的<span lang=EN-US>pod</span>，命令为</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get pods XXXX
-n production -o jsonpath={.spec.volumes} | jq</span></p>

<p class=MsoNormal>模拟环境里的<span lang=EN-US>3</span>个<span lang=EN-US>pod</span>，都没有挂载<span
lang=EN-US>volume</span>，所以无需删除了。考试中也是这样的，都没有挂载<span lang=EN-US>volume</span>。</p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=760 height=683
id="图片 55" src="CKS考试模拟题-2022-01-07.files/image033.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>什么样的是挂载了<span lang=EN-US>volume</span>的<span lang=EN-US>pod</span>呢？</p>

<p class=MsoNormal>比如<span lang=EN-US>kube-system</span>命名空间下的<span lang=EN-US>etcd-master01</span>是挂载了<span
lang=EN-US>volume</span>的。</p>

<p class=MsoNormal>具体是否挂载，可以依据是否有<span lang=EN-US>hostPath</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=790 height=315
id="图片 57" src="CKS考试模拟题-2022-01-07.files/image034.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>10</span>、网络策略 <span lang=EN-US>NetworkPolicy</span></h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>Task</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>create a
NetworkPolicy named <span style='color:#0070C0'>pod-restriction</span>
torestrict access to <a name="_Hlk90588764">Pod <span style='color:#0070C0'>products-service</span></a>
running in namespace <span style='color:#0070C0'>dev-team</span> .</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>only allow
the following Pods to connect to Pod<span style='color:#0070C0'>
products-service</span> :</span></p>

<p class=MsoNormal style='text-indent:5.25pt;border:none;padding:0cm'><span
lang=EN-US>&gt;Pods in the namespace <span style='color:#0070C0'>qa</span></span></p>

<p class=MsoNormal style='text-indent:5.25pt;border:none;padding:0cm'><span
lang=EN-US>&gt;<a name="_Hlk91769646">Pods with label <span style='color:#0070C0'>environment:
testing</span> , in any namespace</a></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Make sure
to apply the NetworkPolicy. </span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>You can
find a skelet on manifest file at <span style='color:#0070C0'>/cks/net/po.yaml</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>解读：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'>创建一个名为<span lang=EN-US>
pod-restriction </span>的网络策略，以限制命名空间<span lang=EN-US> dev-team </span>中<span
lang=EN-US> products-service Pod</span>。</p>

<p class=MsoNormal style='border:none;padding:0cm'>只允许以下<span lang=EN-US> Pod </span>连接<span
lang=EN-US> products-service Pod</span>：</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&#61548; qa </span>命名空间中的<span
lang=EN-US> Pod</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&#61548; </span>在任何命名空间，标签为<span
lang=EN-US> environment:testing</span>的<span lang=EN-US>Pod</span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#networkpolicy-resource">https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/#networkpolicy-resource</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=926 height=788
id="图片 42" src="CKS考试模拟题-2022-01-07.files/image035.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSSH00301</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>我这里应提前打好标签了，所以你只需要检查标签即可。<span style='color:red'>（但为了防止考试时，没有给你打标签，所以还是需要你将上面两条打标签的命令记住。）</span></p>

<p class=MsoNormal><span lang=EN-US># </span>查看<span lang=EN-US> qa </span>命名空间标签（<span
lang=EN-US>name: qa</span>）</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get ns
--show-labels</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=670 height=274
id="图片 39" src="CKS考试模拟题-2022-01-07.files/image036.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US># </span>查看<span lang=EN-US> pod </span>标签（<span
lang=EN-US>environment: testing</span>）</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get pod -n
dev-team --show-labels</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=622 height=69 id="图片 40"
src="CKS考试模拟题-2022-01-07.files/image037.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>如果<span lang=EN-US> Pod </span>或者<span lang=EN-US> Namespace
</span>没有标签，则需要打上标签。</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl label ns qa
name=qa</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl label pod
products-service environment=testing -n dev-team</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>创建<span lang=EN-US> NetworkPolicy</span>：</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vi /cks/net/po.yaml</span></p>

<p class=MsoNormal>根据官网，修改为如下内容：</p>

<p class=MsoNormal><span lang=EN-US>apiVersion: networking.k8s.io/v1</span></p>

<p class=MsoNormal><span lang=EN-US>kind: NetworkPolicy</span></p>

<p class=MsoNormal><span lang=EN-US>metadata:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; name:
pod-restriction&nbsp;&nbsp; #</span><span style='color:#00B050'>修改</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; </span><span
lang=EN-US style='color:red'>namespace: dev-team&nbsp;&nbsp;&nbsp;&nbsp; #</span><span
style='color:red'>修改</span></p>

<p class=MsoNormal><span lang=EN-US>spec:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; podSelector:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; matchLabels:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<a name="_Hlk91769770">environment: testing</a>&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='color:red'>#</span><span style='color:red'>根据题目要求的标签修改，这个写的是<span
lang=EN-US>POD &nbsp;products-service</span>的标签，也就是使用<span lang=EN-US>kubectl
get pod -n dev-team --show-labels</span>查出来的<span lang=EN-US>pod</span>的标签，这个标签不要和题目里要求的“<span
lang=EN-US>Pods with label environment: testing , in any namespace</span>”这句话里的标签混淆了，两个没有关系，所以可不一样。比如你考试时查出来的<span
lang=EN-US>POD&nbsp; products-service</span>的标签是<span lang=EN-US>name: products</span>，那这里的<span
lang=EN-US>environment: testing</span>就要换成<span lang=EN-US>name: products</span>。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; policyTypes:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:red'>&nbsp; - Ingress&nbsp;&nbsp;&nbsp;
#</span><span style='color:red'>注意，这里只写<span lang=EN-US>&nbsp; - Ingress</span>，不要将<span
lang=EN-US>&nbsp; - Egress</span>也复制进来！</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; ingress:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; -
from:&nbsp;&nbsp;&nbsp; #</span><span style='color:#00B050'>第一个<span
lang=EN-US>from</span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; - namespaceSelector:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
matchLabels:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US style='color:red'>name: qa&nbsp;&nbsp;&nbsp; #</span><span
style='color:red'>命名空间有<span lang=EN-US>name: qa</span>标签的</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; -
from:&nbsp;&nbsp;&nbsp; #</span><span style='color:#00B050'>第二个<span
lang=EN-US>from</span></span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='color:red'>- namespaceSelector: {}</span><span lang=EN-US
style='color:#00B050'>&nbsp; #</span><span style='color:#00B050'>修改为这样，所有命名空间</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
podSelector:&nbsp;&nbsp; #</span><span style='color:#00B050'>注意，这个<span
lang=EN-US>podSelector</span>前面的<span lang=EN-US>“-” </span>要删除，换成空格，空格对齐要对。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
matchLabels:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
environment: testing&nbsp;&nbsp; </span><span lang=EN-US style='color:red'>#</span><span
style='color:red'>有<span lang=EN-US>environment: testing</span>标签的<span
lang=EN-US>Pod</span>，这个地方是根据题目要求“<span lang=EN-US>Pods with label environment:
testing , in any namespace</span>”，这句话里的<span lang=EN-US>pod</span>标签写的。不要和上面<span
lang=EN-US>spec</span>里的混淆。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>创建</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl apply -f
/cks/net/po.yaml</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>检查</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get
networkpolicy -n dev-team</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=460 height=73 id="图片 14"
src="CKS考试模拟题-2022-01-07.files/image038.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>11</span>、<span lang=EN-US>Trivy </span>扫描镜像安全漏洞</h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>Task</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Use the
Trivy open-source container scanner to detect images with severe
vulnerabilities used by Pods in the namespace <span style='color:#0070C0'>kamino</span>.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Look for
images with <b>High</b> or <b>Critical</b> severity vulnerabilities,and delete
the Pods that use those images. </span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Trivy is
pre-installed on the cluster’s <b>master</b> node <b>only</b>; it is not
available on the base system or the worker nodes. </span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>You’ll have
to connect to the <b>cluster’s master node</b> to use Trivy</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>解读：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'>对<span lang=EN-US> kamino </span>命名空间中<span
lang=EN-US> pod </span>使用<span lang=EN-US> Trivy </span>工具扫描镜像安全漏洞。</p>

<p class=MsoNormal style='border:none;padding:0cm'>查找具有高危或严重漏洞的镜像， 并删除使用这些镜像的 <span
lang=EN-US>Pod</span>。</p>

<p class=MsoNormal style='border:none;padding:0cm'>注：<span lang=EN-US> Trivy </span>已经预装集群的<span
lang=EN-US> master </span>节点，工作节点不可用。</p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://github.com/aquasecurity/trivy">https://github.com/aquasecurity/trivy</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSSC00401</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>方法<span lang=EN-US>1</span>：</b></p>

<p class=MsoNormal>需要从控制台<span lang=EN-US>ssh</span>到<span lang=EN-US>master</span>节点</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>ssh root@master01</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>检查所有<span lang=EN-US>pod</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get pod -n
kamino</span></p>

<p class=MsoNormal>获取每一个<span lang=EN-US>pod</span>的<span lang=EN-US>image</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubect get pod XXXX
-n kamino -o yaml | grep image</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>检查镜像是否有高危和严重的漏洞</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>trivy image -s </span><span
lang=EN-US style='color:red'>HIGH,CRITICAL</span><span lang=EN-US
style='color:#C45911'> </span><span lang=EN-US style='color:#0070C0'>nginx:1.19</span><span
lang=EN-US>&nbsp;&nbsp; <span style='color:#00B050'>#</span><span
style='color:red'> HIGH,CRITICAL</span></span><span style='color:red'>，</span><span
style='color:#00B050'>这里的<span lang=EN-US>nginx:1.19</span>换成你上一步查出来的镜像名字</span></p>

<p class=MsoNormal>或者也可以使用下面命令查询</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'># trivy image
nginx:1.19 | grep -iE 'High|Critical'</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>删除有问题的<span lang=EN-US>pod</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl delete pod
XXXX -n kamino</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='color:#0070C0'>请注意，考试时有<span lang=EN-US>2</span>个镜像，<span
lang=EN-US>4</span>个<span lang=EN-US>pod</span>，其中一个镜像异常，需要删除对应的<span
lang=EN-US>2</span>个<span lang=EN-US>pod</span>。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='color:#0070C0'>考试中的<span lang=EN-US>pod</span>比较多，如果一个个查，比较浪费时间。<span
lang=EN-US>shell</span>脚本好的同学，可以使用方法<span lang=EN-US>2</span>，写一个<span
lang=EN-US>while</span>循环。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>方法<span lang=EN-US>2</span>：</b></p>

<p class=MsoNormal>（对于<span lang=EN-US>pod</span>数量多的情况，可以使用下面方法）</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>需要从控制台<span lang=EN-US>ssh</span>到<span lang=EN-US>master</span>节点</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>ssh root@master01</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>检查所有<span lang=EN-US>pod</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get po -n kamino</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get po -n
kamino | grep -v &quot;NAME&quot; | awk '{print $1}' &gt; podlist.txt</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>cat podlist.txt</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>循环检查<span lang=EN-US>pod</span>里的<span lang=EN-US>image</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>while read line;do</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>echo $line</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get pod -n
kamino $line -o yaml | grep &quot;image:&quot;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>done &lt; podlist.txt</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>对查出来的<span lang=EN-US>image</span>逐一扫描</p>

<p class=MsoNormal><a name="_Hlk89951138"><span lang=EN-US style='color:#C45911'>trivy
image -s HIGH,CRITICAL nginx:1.19</span></a><span lang=EN-US>&nbsp;&nbsp;&nbsp;
#</span>注意<span lang=EN-US>HIGH,CRITICAL</span>为大写</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>删除扫描的镜像带有高危或严重漏洞的<span lang=EN-US> Pod</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl delete pod
XXXX -n kamino</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1026 height=543
id="图片 56" src="CKS考试模拟题-2022-01-07.files/image039.jpg"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>12</span>、<span lang=EN-US>AppArmor</span></h1>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><b><span
lang=EN-US>Context</span></b></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>AppArmor is enabled on the cluster worker node01. An AppArmor
profile is prepared, but not enforced yet.</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>You may use your browser to open one additional tab to access the AppArmor
documentation.</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><b><span
lang=EN-US>Task</span></b></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>On the cluster<span style='color:red'> worker node01</span>, enforce
the prepared AppArmor profile located at<span style='color:#0070C0'>
/etc/apparmor.d/nginx_apparmor</span> . </span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>Edit the prepared manifest file located at <span style='color:#0070C0'>&nbsp;/home/candidate/KSSH00401/nginx-deploy.yaml</span>
&nbsp;to apply the AppArmor profile. </span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>Finally, apply the manifest file and create the pod specified in it.</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><b>解读：
</b></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>在集群的<b><span
lang=EN-US>worker node01</span></b>节点上，执行下面准备好的配置文件<span lang=EN-US>/etc/apparmor.d/nginx_apparmor</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>编辑准备好的清单文件<span
lang=EN-US>/home/candidate/KSSH00401/nginx-deploy.yaml </span>应用于<span
lang=EN-US> AppArmor </span>配置文件。</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>最后，
在<span lang=EN-US> Pod </span>中应用<span lang=EN-US> apparmor </span>策略文件。</p>

</div>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='color:red'>考试中，不会说在那个工作节点上，但是在这道题的开头位置，有显示工作节点的名字，你需要自己<span
lang=EN-US>ssh</span>过去。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=264 height=310 id="图片 45"
src="CKS考试模拟题-2022-01-07.files/image040.jpg"></span><span lang=EN-US>&nbsp;<img
border=0 width=266 height=84 id="图片 50"
src="CKS考试模拟题-2022-01-07.files/image041.jpg"><img border=0 width=289
height=321 id="图片 51" src="CKS考试模拟题-2022-01-07.files/image042.jpg"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/tutorials/clusters/apparmor/#%E4%B8%BE%E4%BE%8B">https://kubernetes.io/zh/docs/tutorials/clusters/apparmor/#%E4%B8%BE%E4%BE%8B</a></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=1026 height=515 id="图片 69"
src="CKS考试模拟题-2022-01-07.files/image043.jpg"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSSH00401</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>需要从控制台<span lang=EN-US>ssh</span>到<span lang=EN-US
style='color:red'>node</span>节点</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>ssh root@node01</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>执行<span lang=EN-US>apparmor</span>策略模块：</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US># </span>切换目录</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>cd /etc/apparmor.d/</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>vi <a name="_Hlk91821552">/etc/apparmor.d/nginx_apparmor</a></span></p>

<p class=MsoNormal align=left style='text-align:left'>注意，<span lang=EN-US>nginx-profile-3</span>这一行要注释掉，但要确保<span
lang=EN-US>profile nginx-profile-3</span>这一行没有注释。</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>#include
&lt;tunables/global&gt;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#00B050'># nginx-profile-3 &nbsp;#</span><span style='color:#00B050'>注释掉
<span lang=EN-US>&nbsp;&nbsp;</span>模拟环境里多写了一行的，导致<span lang=EN-US>apparmor_parser
-q</span>的时候会报错。</span><span style='color:red'>但在新的<span lang=EN-US>1.22</span>的考试中，这个<span
lang=EN-US>/etc/apparmor.d/nginx_apparmor</span>又变成正确的了。所以你在考试时，可以先<span
lang=EN-US>cat /etc/apparmor.d/nginx_apparmor</span>，有错误则改，没错误，则不要再改了。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>profile
nginx-profile-3 flags=(attach_disconnected) {&nbsp;&nbsp;&nbsp; <span
style='color:#00B050'>#</span></span><span style='color:#00B050'>这句是正确的配置，不要修改。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;
#include &lt;abstractions/base&gt;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;
file,</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp; #
Deny all file writes.</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;deny
/** w,</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>}</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>没有<span lang=EN-US>grep</span>到，说明没有启动</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>apparmor_status | grep nginx-profile-3</span></p>

<p class=MsoNormal align=left style='text-align:left'>加载启用这个配置文件</p>

<p class=MsoNormal align=left style='text-align:left'><a name="_Hlk91821532"><span
lang=EN-US style='color:#C45911'>apparmor_parser -q </span></a><span
lang=EN-US style='color:#C45911'>/etc/apparmor.d/nginx_apparmor</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US># </span>再次检查有结果了</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>apparmor_status | grep nginx</span></p>

<p class=MsoNormal align=left style='text-align:left'>显示如下内容</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#0070C0'>&nbsp;&nbsp; nginx-profile-3</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=574 height=93 id="图片 58"
src="CKS考试模拟题-2022-01-07.files/image044.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>修改<span lang=EN-US>pod</span>文件</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>vi /home/candidate/KSSH00401/nginx-deploy.yaml</span></p>

<p class=MsoNormal align=left style='text-align:left'>修改如下内容</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>apiVersion:
v1</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>kind:
Pod</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>metadata:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;
name: podx</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#00B050'>&nbsp; #</span><span style='color:#00B050'>添加<span
lang=EN-US>annotations</span>，<span lang=EN-US>kubernetes.io/podx</span>名字和<span
lang=EN-US>container</span>名字一样即可，<span lang=EN-US>nginx-profile-3</span>为前面在<span
lang=EN-US>worker node01</span>上执行的<span lang=EN-US>apparmor</span>策略模块</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>&nbsp; annotations:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>&nbsp;&nbsp;&nbsp;&nbsp;
container.apparmor.security.beta.kubernetes.io/</span><span lang=EN-US
style='color:red'>podx</span><span lang=EN-US style='color:#C45911'>:
localhost/</span><span lang=EN-US style='color:red'>nginx-profile-3</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>spec:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;
containers:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp; -
image: busybox</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
imagePullPolicy: IfNotPresent</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
name: <span style='color:red'>podx</span></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
command: [ &quot;sh&quot;, &quot;-c&quot;, &quot;echo 'Hello AppArmor!'
&amp;&amp; sleep 1h&quot; ]</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
resources: {}</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;
nodeName: node01</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;
dnsPolicy: ClusterFirst</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;
restartPolicy: Always</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>status:
{}</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>创建</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>kubectl apply -f
/home/candidate/KSSH00401/nginx-deploy.yaml</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='color:red'>因为上面<span
lang=EN-US>ssh</span>了一下，所以操作完成后，记得<span lang=EN-US>exit</span>退出。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>exit</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>检查</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=405 height=85 id="图片 52"
src="CKS考试模拟题-2022-01-07.files/image045.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>可以通过检查该配置文件的<span
lang=EN-US> proc attr </span>来验证容器是否实际使用该配置文件运行：</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>kubectl
exec podx -- cat /proc/1/attr/current</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=487 height=57 id="图片 53"
src="CKS考试模拟题-2022-01-07.files/image046.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>（考试中，这一步不用做）因为我们测试环境里的<span
lang=EN-US>nginx-profile-3</span>策略是拒绝写入，所以如果试图通过写入文件来违反配置文件，会发生什么情况：</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>kubectl
exec podx -- touch /tmp/test</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=433 height=69 id="图片 54"
src="CKS考试模拟题-2022-01-07.files/image047.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>13</span>、<span lang=EN-US>Sysdig &amp; falco </span>（<span
lang=EN-US>1.22</span>不考这道题了，但是也要练会）</h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>you may
user you brower to open one additonal tab to access sysdig documentation ro
Falco documentaion</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>Task:</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>user
runtime detection tools to detect anomalous processes spawning and executing
frequently in the sigle container belorging to Pod <span style='color:#0070C0'>tomcat
</span>.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Tow tools
are avaliable to use:</span></p>

<p class=MsoNormal style='text-indent:10.5pt;border:none;padding:0cm'><span
lang=EN-US style='color:#0070C0'>sysdig</span></p>

<p class=MsoNormal style='text-indent:10.5pt;border:none;padding:0cm'><span
lang=EN-US style='color:#0070C0'>falco</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>the tools
are pre-installed on the cluster <span style='color:red'>worker node01</span> <b>only</b>;the
are not avaliable on the base system or the master node.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>using the
tool of you choice(including any non pre-install tool) analyse the container
behaviour for at lest 30 seconds, using filers that detect newly spawing and
executing processes.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>store an
incident file at <span style='color:#0070C0'>/opt/KSR00101/incidents/summary </span>,containing
the detected incidents one per line in the follwing format:</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#0070C0'>[timestamp],[uid],[processName]</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Keep the
tool's original timestamp-format as-is.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>解读：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'>使用运行时检测工具来检测<span
lang=EN-US> Pod tomcat </span>单个容器中频发生成和执行的异常进程。</p>

<p class=MsoNormal style='border:none;padding:0cm'>有两种工具可供使用：</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&#61548; &gt; sysdig</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&#61548; &gt; falco</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>注： 这些工具只预装在集群的工作节点，不在<span
lang=EN-US> master </span>节点。</p>

<p class=MsoNormal style='border:none;padding:0cm'>使用工具至少分析<span lang=EN-US>30</span>秒
，使用过滤器检查生成和执行的流程 ， 将事件写到<span style='color:#0070C0'> <a name="_Hlk88774494"><span
lang=EN-US>/opt/KSR00101/incidents/summary</span></a></span><span lang=EN-US> </span>文件，
</p>

<p class=MsoNormal style='border:none;padding:0cm'>其中包含检测的事件， 格式如下：</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>[timestamp],[uid],[processName]</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>保持工具的原始时间戳格式不变。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>注： 确保事件文件存储在集群的工作节点上。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal>无</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal><span style='color:red'>（近期反馈，这道题不考了，但也要练会）</span></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSSG00201</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>从控制台<span lang=EN-US> ssh </span>到<span lang=EN-US
style='color:red'> worker node01 </span><span style='color:red'>节点</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>ssh root@node01</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>首先找到容器的<span lang=EN-US> container id</span>：，我这里的容器<span
lang=EN-US>id</span>为<span lang=EN-US>2edce765890e</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>docker ps | grep
tomcat</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>通过<span lang=EN-US> sysdig </span>扫描容器<span lang=EN-US>30s</span>并输出到指定文件：</p>

<p class=MsoNormal><span lang=EN-US>sysdig -h </span>和<span lang=EN-US>-l </span>查看帮助</p>

<p class=MsoNormal>注：可以使用<span lang=EN-US> sysdig -l |grep time </span>过滤，确认输出格式字段</p>

<p class=MsoNormal><span lang=EN-US>sysdig -l | grep time</span></p>

<p class=MsoNormal><span lang=EN-US>sysdig -l | grep uid</span></p>

<p class=MsoNormal><span lang=EN-US>sysdig -l | grep proc</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>开始扫描</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>sudo sysdig -M 30 -p
&quot;<a name="_Hlk90241559">%evt.time,%user.uid</a>,%proc.name&quot;
container.id=2edce765890e &gt; /opt/KSR00101/incidents/summary</span></p>

<p class=MsoNormal><span lang=EN-US style='color:red'>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span style='color:red'>因为上面<span
lang=EN-US>ssh</span>了一下，所以操作完成后，记得<span lang=EN-US>exit</span>退出。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>exit</span></p>

<p class=MsoNormal><span lang=EN-US style='color:red'>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:red'>&nbsp;</span></p>

<p class=MsoNormal><span style='color:red'>注意<span lang=EN-US>-M</span>后面带秒数。</span></p>

<p class=MsoNormal><span lang=EN-US style='color:red'>%evt.time</span><span
style='color:red'>和<span lang=EN-US>%user.uid</span>之间用的是英文逗号，这里具体用什么符号，要根据题目要求，模拟题的题目里是逗号。</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=269 height=40 id="图片 33"
src="CKS考试模拟题-2022-01-07.files/image048.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1026 height=187
id="图片 11" src="CKS考试模拟题-2022-01-07.files/image049.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>14</span>、<span lang=EN-US>Pod </span>安全策略（<span
lang=EN-US>PodSecurityPolicy PSP</span>）</h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>context</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>A
PodsecurityPolicy shall prevent the creati on of privileged Pods in a specific
namespace.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>Task</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Create a
new PodSecurityPolicy named<span style='color:#0070C0'> restrict-policy </span>,
which prevents the creation of privileged Pods.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Create a
new ClusterRole named <span style='color:#0070C0'>restrict-access-role </span>,
which uses the newly created PodSecurityPolicy <span style='color:#0070C0'>restrict-policy</span>
.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Create a
new serviceAccount named <span style='color:#0070C0'>psp-denial-sa </span>in
the existing namespace <span style='color:#0070C0'>staging </span>.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Finally,
create a new clusterRoleBinding named <span style='color:#0070C0'>dany-access-bind</span>
, which binds the newlycreated ClusterRole<span style='color:#0070C0'>
restrict-access-role</span> to the newly created serviceAccount <span
style='color:#0070C0'>psp-denial-sa</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>You can
find a skeleton manifest file</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><a name="_Hlk88604874"><span
lang=EN-US style='color:#0070C0'>/cks/psp/psp.yaml</span></a></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>内容：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>解读：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1. </span>创建一个名为<span
lang=EN-US> restrict-policy </span>的<span lang=EN-US> PodSecurityPolicy</span>，
阻止创建特权<span lang=EN-US> Pod</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>2. </span>创建一个名为<span
lang=EN-US> restrict-access-role </span>的<span lang=EN-US> ClusterRole </span>能够使用<span
lang=EN-US> PSP restrict-policy</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>3. </span>在<span
lang=EN-US> staging </span>命名空间创建一个名为<span lang=EN-US> psp-denial-sa </span>的<span
lang=EN-US> ServiceAccount</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>4. </span>最后，
创建一个名为<span lang=EN-US> dany-access-bind </span>的<span lang=EN-US>
ClusterRoleBinding</span>， 绑定<span lang=EN-US> ClusterRole restrict-access-role
</span>到<span lang=EN-US> ServiceAccount psp-denial-sa</span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal>四个都要看</p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/#%E9%80%89%E9%A1%B9">https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/#%E9%80%89%E9%A1%B9</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1019 height=543
id="图片 31" src="CKS考试模拟题-2022-01-07.files/image050.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AD%96%E7%95%A5%E5%92%8C%E4%B8%80%E4%B8%AA-pod">https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%AD%96%E7%95%A5%E5%92%8C%E4%B8%80%E4%B8%AA-pod</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1026 height=566
id="图片 12" src="CKS考试模拟题-2022-01-07.files/image051.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#via-rbac">https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#via-rbac</a></span></p>

<p class=MsoNormal>如果<a name="_Hlk91770006">使用命令不会创建<span lang=EN-US>clusterrole</span>和<span
lang=EN-US>clusterrolebinding</span></a>，则可以参考官网的<span lang=EN-US>yaml</span>文件，修改并使用<span
lang=EN-US>kubectl apply -f</span>来创建。</p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=900 height=836
id="图片 63" src="CKS考试模拟题-2022-01-07.files/image052.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#example">https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#example</a></span></p>

<p class=MsoNormal>使用命令创建<span lang=EN-US>clusterrole</span>和<span lang=EN-US>clusterrolebinding</span>的参考方法</p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1027 height=364
id="图片 64" src="CKS考试模拟题-2022-01-07.files/image053.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSMV00102</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>需要从控制台<span lang=EN-US>ssh</span>到<span lang=EN-US>master</span>节点，</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>ssh root@master01</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>启用<span lang=EN-US>PSP</span>准入控制器（考试中默认已经启用，但以防万一，还是要检查一下的。）</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>cat
/etc/kubernetes/manifests/kube-apiserver.yaml | grep PodSecurityPolicy</span></p>

<p class=MsoNormal>确保有如下一行，<span style='color:red'>在<span lang=EN-US>1.22</span>的考试中，这一行已经提前给你加上了，但还是需要检查确认一下。</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp; -
--enable-admission-plugins=NodeRestriction,</span><span lang=EN-US
style='color:red'>PodSecurityPolicy</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>如果没有，则先备份配置文件，再添加这行，最后重启<span lang=EN-US>kubelet</span>。</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vi
/etc/kubernetes/manifests/kube-apiserver.yaml</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>systemctl restart
kubelet</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>官方网址里复制<span lang=EN-US>PSP</span>的内容，并修改拒绝特权。（考试中会给出参考的<span
lang=EN-US>yaml</span>文件，可以修改这个文件。）</p>

<p class=MsoNormal>创建名为<span lang=EN-US>prevent-psp-policy</span>的<span
lang=EN-US>PodSecurityPolicy</span>，阻止创建<span lang=EN-US>Privileged Pod</span>：</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vi /cks/psp/psp.yaml</span></p>

<p class=MsoNormal>修改如下内容</p>

<p class=MsoNormal><span lang=EN-US>apiVersion: policy/v1beta1</span></p>

<p class=MsoNormal><span lang=EN-US>kind: PodSecurityPolicy</span></p>

<p class=MsoNormal><span lang=EN-US>metadata:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; name:
restrict-policy&nbsp;&nbsp; #</span><span style='color:#00B050'>修改<span
lang=EN-US>name</span></span></p>

<p class=MsoNormal><span lang=EN-US>spec:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp; privileged:
false&nbsp; # </span><span style='color:#00B050'>修改为<span lang=EN-US>false</span>，阻止创建<span
lang=EN-US>Privileged Pod</span>（特权<span lang=EN-US>pod</span>）</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; seLinux:&nbsp; &nbsp;<span
style='color:#0070C0'>&nbsp;#</span></span><span style='color:#0070C0'>下面这些信息，根据官网拷贝。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; rule: RunAsAny</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; supplementalGroups:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; rule: RunAsAny</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; runAsUser:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; rule: RunAsAny</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; fsGroup:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp; rule: RunAsAny</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; volumes:</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; - '*'</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>创建</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl apply -f
/cks/psp/psp.yaml</span></p>

<p class=MsoNormal>检查</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl get podsecuritypolicy</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1026 height=89
id="图片 19" src="CKS考试模拟题-2022-01-07.files/image054.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>方法<span lang=EN-US>1</span>：</b></p>

<p class=MsoNormal>创建<span lang=EN-US>CluserRole</span>和<span lang=EN-US>ServiceAccount</span>，并通过<span
lang=EN-US>ClusterRoleBinding</span>绑定：</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl create
clusterrole restrict-access-role --verb=use --resource=psp
--resource-name=restrict-policy&nbsp; </span><span lang=EN-US style='color:
#0070C0'>&nbsp;#</span><span style='color:#0070C0'>不会写的话，可以参考官网链接的<span
lang=EN-US>yaml</span>格式修改创建。</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl create sa
psp-denial-sa -n staging</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl create
clusterrolebinding dany-access-bind --clusterrole=restrict-access-role
--serviceaccount=staging:psp-denial-sa</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>方法<span lang=EN-US>2</span>：</b></p>

<p class=MsoNormal><span lang=EN-US style='color:red'>1.22</span><span
style='color:red'>考试中，已经给你<span lang=EN-US>3</span>个空的<span lang=EN-US>yaml</span>文件了，所以可以使用方法<span
lang=EN-US>2</span>来做，先修改<span lang=EN-US>yaml</span>文件，再<span lang=EN-US>apply</span>。</span></p>

<p class=MsoNormal>参考官网，通过<span lang=EN-US>yaml</span>文件来创建，<span lang=EN-US>CluserRole</span>和<span
lang=EN-US>ServiceAccount</span>，以及<span lang=EN-US>ClusterRoleBinding</span>绑定</p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#via-rbac">https://kubernetes.io/zh/docs/concepts/policy/pod-security-policy/#via-rbac</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>检查</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>kubectl describe
clusterrolebinding dany-access-bind</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=573 height=275 id="图片 9"
src="CKS考试模拟题-2022-01-07.files/image055.png"></span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=607 height=262
id="图片 29" src="CKS考试模拟题-2022-01-07.files/image056.png"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>15</span>、启用<span lang=EN-US>API server</span>认证</h1>

<p class=MsoNormal align=left style='text-align:left'><span style='color:#00B0F0'>（需要手动初始化环境）</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><b><span
lang=EN-US>Context</span></b></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>由<span
lang=EN-US> kubeadm</span>创建的<span lang=EN-US> cluster</span>的<span lang=EN-US>
KubernetesAPI</span>服务器，出于测试目的，临时配置为允许未经身份验证和未经授权的访问，授予匿名用户集群管理员<span
lang=EN-US>cluster-admin</span>的访问权限。</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>Task</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>要求：
重新配置集群的<span lang=EN-US> Kubernetes API </span>服务器，以确保只允许经过身份验证和授权的 <span
lang=EN-US>REST</span>请求。</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&#61548; &gt; </span>使用授权模式 <span lang=EN-US style='color:#0070C0'>Node,RBAC</span><span
lang=EN-US> </span>和准入控制器 <span lang=EN-US style='color:#0070C0'>NodeRestriction</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'><span
lang=EN-US>&#61548; &gt; </span>删除名为 <span lang=EN-US style='color:#0070C0'>system:anonymous</span><span
lang=EN-US> </span>的<span lang=EN-US style='color:#0070C0'> <a
name="_Hlk88773848">ClusterRoleBinding</a></span>来进行清理。</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>注意：<span
style='color:red'>（考试中，下面注意的内容，你无需做任何操作，只需要做上面的两步即可。）</span></p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>所有<span
lang=EN-US> kubect</span>配置环境文件也被配置为使用未经身份验证和未经授权的访问。您不必更改它，但请注意，一旦完成<span
lang=EN-US> cluster</span>的安全加固，<span lang=EN-US>kubectl</span>的配置将无法工作。</p>

<p class=MsoNormal align=left style='text-align:left;border:none;padding:0cm'>您可以使用位于<span
lang=EN-US> cluster</span>的<span lang=EN-US> master</span>节点上，<span lang=EN-US>cluster</span>原本的<span
lang=EN-US> kubectl</span>配置文件<span lang=EN-US>/etc/kubernetes/admin.conf</span>，以确保经过身份验证和授权的请求仍然被允许。</p>

</div>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/">https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1027 height=384
id="图片 3" src="CKS考试模拟题-2022-01-07.files/image057.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1027 height=520
id="图片 7" src="CKS考试模拟题-2022-01-07.files/image058.jpg"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=957 height=257 id="图片 36"
src="CKS考试模拟题-2022-01-07.files/image059.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=973 height=239 id="图片 37"
src="CKS考试模拟题-2022-01-07.files/image060.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US><img
border=0 width=943 height=235 id="图片 38"
src="CKS考试模拟题-2022-01-07.files/image061.png"></span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>初始化这道题的环境</span></b></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'>请先执行如下命令，模拟这道题的初始环境。（将以下所有命令粘贴到<span
lang=EN-US>master01</span>执行。）</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#7030A0'>sed -i 's/authorization-mode=Node,RBAC/authorization-mode=AlwaysAllow/'
/etc/kubernetes/manifests/kube-apiserver.yaml</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#7030A0'>sed -i
's/enable-admission-plugins=NodeRestriction,PodSecurityPolicy/enable-admission-plugins=AlwaysAdmit/'
/etc/kubernetes/manifests/kube-apiserver.yaml</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US
style='color:#7030A0'>sed -i
's/enable-admission-plugins=NodeRestriction/enable-admission-plugins=AlwaysAdmit/'
/etc/kubernetes/manifests/kube-apiserver.yaml</span></p>

</div>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSCF00301</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>确保只有认证并且授权过的<span lang=EN-US>REST</span>请求才被允许。</p>

<p class=MsoNormal>编辑<span lang=EN-US>/etc/kubernetes/manifests/<a
name="_Hlk88773828">kube-apiserver.yaml</a></span>，修改下面内容</p>

<p class=MsoNormal><span lang=EN-US>- --authorization-mode=AlwaysAllow</span></p>

<p class=MsoNormal><span lang=EN-US>- --enable-admission-plugins=AlwaysAdmit</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vi
/etc/kubernetes/manifests/kube-apiserver.yaml</span></p>

<p class=MsoNormal align=left style='text-align:left'>修改为</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#00B050'>-
--authorization-mode=Node,RBAC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='color:#00B050'>注意，只保留<span lang=EN-US>Node,RBAC</span>这两个，中间是英文状态下的逗号。</span><a
name="_Hlk91822033"><span style='color:red'>在<span lang=EN-US>1.22</span>考试中，这一条默认已经有了</span></a><span
style='color:red'>，但还是要检查确认一下。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#00B050'>- --enable-admission-plugins=<a name="_Hlk88772558">NodeRestriction</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='color:#00B050'>在<span lang=EN-US>1.22</span>考试中，这一个原先为<span
lang=EN-US>AlwaysAdmit</span>，需要修改为<span lang=EN-US>NodeRestriction</span>。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:gray'>- --client-ca-file=/etc/kubernetes/pki/ca.crt&nbsp;&nbsp; #</span><span
style='color:gray'>这一条也要检查一下，是否存在配置文件中，如果没有，也需要添加。</span><span
style='color:red'>在<span lang=EN-US>1.22</span>考试中，这一条默认已经有了。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:gray'>- --enable-bootstrap-token-auth=true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#</span><span style='color:gray'>这一条也要检查一下，是否存在配置文件中，如果没有，也需要添加。</span><span
style='color:red'>在<span lang=EN-US>1.22</span>考试中，这一条默认已经有了。</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>另外，在这组<span lang=EN-US>- --</span>的最后一行，有一个<span
lang=EN-US>- --anonymous-auth=true &nbsp;</span>，我觉得应该要注释掉这行。但是在现有网上流传的答案中，没有注释，所以最终我<span
lang=EN-US>1.22</span>的考试时，也没有敢去注释。</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>重启<span lang=EN-US>kubelet</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>systemctl restart kubelet</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US># </span>删除题目要求的角色绑定</p>

<p class=MsoNormal align=left style='text-align:left'><span style='color:red'>注意，如果考题里没有明确要求你，删除名为<span
lang=EN-US> system:anonymous </span>的<span lang=EN-US> ClusterRoleBinding</span>，则不需要执行下面的步骤。</span></p>

<p class=MsoNormal align=left style='text-align:left'>查</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>kubectl get clusterrolebinding system:anonymous</span></p>

<p class=MsoNormal align=left style='text-align:left'>删</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>kubectl delete clusterrolebinding system:anonymous</span></p>

<p class=MsoNormal align=left style='text-align:left'>再检查</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>kubectl get clusterrolebinding system:anonymous</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<h1><span lang=EN-US>16</span>、<span lang=EN-US>ImagePolicyWebhook</span>容器镜像扫描</h1>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<div style='border:solid windowtext 1.0pt;padding:1.0pt 4.0pt 1.0pt 4.0pt'>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>context</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>A container
image scanner is set up on the cluster,but It's not yet fully integrated into
the cluster's configuration .</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>When complete,the
container image scanner shall scall scan for and reject the use of vulnerable
images.</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b><span lang=EN-US>Task</span></b></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>You have to
complete the entire task on the cluster master node,where all services and
files have been prepared and placed</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Given an
incomplete configuration in directory <span style='color:#0070C0'>/etc/kubernetes/epconfig</span>
</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>and a
functional container image scanner with HTTPS sendpitont <span
style='color:#0070C0'>https://acme.local:8082/image_policy</span></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1.enable
the necessary plugins to create an image policy</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>2.validate
the control configuration and chage it to an implicit deny</span>（隐式拒绝）</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>3.Edit the
configuration to point the provied HTTPS endpoint correctiy</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>Finally,test
if the configurateion is working by trying to deploy the valnerable resource <a
name="_Hlk88757904"><span style='color:#0070C0'>/csk/img/web1.yaml</span></a></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>You can
find the container image scanner's log file at /var/log/ imagepolicy/roadrunner.log</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><b>内容：</b></p>

<p class=MsoNormal style='border:none;padding:0cm'>集群上设置了容器图像扫描仪，但尚未完全集成到集群的配置中。</p>

<p class=MsoNormal style='border:none;padding:0cm'>完成后，集装箱图像扫描仪应扫描并拒绝使用易受攻击的图像。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>解读： </p>

<p class=MsoNormal style='border:none;padding:0cm'><span style='color:red'>提示： 必须在集群<span
lang=EN-US> master </span>节点完成任务， 其中包含的所有服务和文件已准备好。</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>在<span lang=EN-US>/etc/kubernetes/epconfig
</span>目录下有一个不完整的配置和一个功能容器镜像扫描器<span lang=EN-US>HTTPS </span>端点：<span
lang=EN-US> <a name="_Hlk88755921">https://acme.local:8082/image_policy</a></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>1. </span>启用准入控制插件</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>2. </span>验证控制配置并将其更改为默认拒绝。</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>3. </span>修改配置文件，
指向正确的<span lang=EN-US> HTTPS </span>端点</p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>最后， 尝试部署易受供攻击的资源来测试配置是否有效。 <span
lang=EN-US>&nbsp;<a name="_Hlk90135465">/csk/img/web1.yaml</a></span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='border:none;padding:0cm'>查看容器扫描日志：<span lang=EN-US>
/var/log/imagepolicy/roadrunner.log</span></p>

<p class=MsoNormal style='border:none;padding:0cm'><span lang=EN-US>&nbsp;</span></p>

</div>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b>参考资料：</b></p>

<p class=MsoNormal>三个网址都要看</p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#%E5%A6%82%E4%BD%95%E5%90%AF%E7%94%A8%E4%B8%80%E4%B8%AA%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E5%99%A8">https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#%E5%A6%82%E4%BD%95%E5%90%AF%E7%94%A8%E4%B8%80%E4%B8%AA%E5%87%86%E5%85%A5%E6%8E%A7%E5%88%B6%E5%99%A8</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook">https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#imagepolicywebhook</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><a
href="https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/#log-%E5%90%8E%E7%AB%AF">https://kubernetes.io/zh/docs/tasks/debug-application-cluster/audit/#log-%E5%90%8E%E7%AB%AF</a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1027 height=341
id="图片 47" src="CKS考试模拟题-2022-01-07.files/image062.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1026 height=576
id="图片 48" src="CKS考试模拟题-2022-01-07.files/image063.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1026 height=506
id="图片 49" src="CKS考试模拟题-2022-01-07.files/image064.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US><img border=0 width=1027 height=849
id="图片 32" src="CKS考试模拟题-2022-01-07.files/image065.jpg"></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><b><span style='background:yellow'>答题：</span></b></p>

<p class=MsoNormal>考试时，要先切换集群</p>

<p class=MsoNormal><span lang=EN-US># kubectl config use-context KSSH00901</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>本题分数比较多，占<span lang=EN-US>10%</span>。</p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>需要从控制台<span lang=EN-US>ssh</span>到<span lang=EN-US>master</span>节点</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>ssh root@master01</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>第一步，编辑<span lang=EN-US>admission_configuration.json</span>（题目会给），修改<span
lang=EN-US>defaultAllow</span>为<span lang=EN-US>false</span>：</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vi /etc/kubernetes/<a
name="_Hlk88758032">epconfig</a>/admission_configuration.json</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>{</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; &quot;imagePolicy&quot;: {</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;
&quot;kubeConfigFile&quot;: &quot;/etc/kubernetes/epconfig/kubeconfig.yaml&quot;,</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;
&quot;allowTTL&quot;: 50,</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp;
&quot;denyTTL&quot;: 50,</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;&nbsp;&nbsp;&nbsp; &quot;retryBackoff&quot;:
500,</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>&nbsp;&nbsp;&nbsp;&nbsp;
&quot;defaultAllow&quot;: false </span><span lang=EN-US>&nbsp;<span
style='color:#00B050'>#</span></span><span style='color:#00B050'>改为<span
lang=EN-US>false</span></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp; }</span></p>

<p class=MsoNormal><span lang=EN-US>}</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>第二步，编辑<span lang=EN-US>/etc/kubernetes/epconfig/kubeconfig.yaml</span>，添加<span
lang=EN-US> webhook server </span>地址：</p>

<p class=MsoNormal>操作前，先备份配置文件</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>mkdir bak16</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>cp /etc/kubernetes/epconfig/kubeconfig.yaml&nbsp;
bak16/</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>vi /etc/kubernetes/epconfig/kubeconfig.yaml</span></p>

<p class=MsoNormal align=left style='text-align:left'>修改如下内容</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>apiVersion:
v1</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>kind:
Config</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>clusters:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>-
cluster:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
certificate-authority: /etc/kubernetes/epconfig/webhook.pem</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>&nbsp;&nbsp;&nbsp; server:
https://acme.local:8082/image_policy</span><span lang=EN-US style='color:#00B050'>
&nbsp;#</span><span style='color:#00B050'>添加<span lang=EN-US>webhook server</span>地址</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;
name: bouncer_webhook</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>contexts:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>-
context:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
cluster: bouncer_webhook</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
user: api-server</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;
name: bouncer_validator</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>current-context:
bouncer_validator</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>preferences:
{}</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>users:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>- name:
api-server</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;
user:</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
client-certificate: /etc/kubernetes/epconfig/apiserver-client.pem</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;&nbsp;&nbsp;
client-key:&nbsp; /etc/kubernetes/epconfig/apiserver-clientkey.pem</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal>第三步，编辑<span lang=EN-US>kube-apiserver.yaml</span>，从官网中引用<span
lang=EN-US> ImagePolicyWebhook </span>的配置信息：</p>

<p class=MsoNormal>操作前，先备份配置文件</p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>mkdir bak16</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>cp
/etc/kubernetes/manifests/kube-apiserver.yaml&nbsp; bak16/</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#C45911'>vi
/etc/kubernetes/manifests/kube-apiserver.yaml</span></p>

<p class=MsoNormal>在<span lang=EN-US>- command:</span>下添加如下内容，注意空格要对齐</p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp; -
--enable-admission-plugins=NodeRestriction,ImagePolicyWebhook</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp; -
--admission-control-config-file=/etc/kubernetes/epconfig/admission_configuration.json&nbsp;&nbsp;&nbsp;
</span><span lang=EN-US style='color:red'>#</span><span style='color:red'>在<span
lang=EN-US>1.22</span>的考试中，默认这行已经添加了，但为了以防万一，模拟环境，没有添加，需要你手动添加。考试时，你先检查，有的话，就不要再重复添加了。</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US># </span>在<span lang=EN-US>kube-apiserver.yaml</span>的<span
lang=EN-US> volumeMounts </span>增加</p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp;
volumeMounts: </span><span lang=EN-US>&nbsp;<span style='color:#0070C0'>&nbsp;#</span></span><span
style='color:#0070C0'>在<span lang=EN-US>volumeMounts</span>下面增加 <span
lang=EN-US>&nbsp;&nbsp;</span></span><span lang=EN-US style='color:red'>#</span><span
style='color:red'>注意，在<span lang=EN-US>1.22</span>考试中，蓝色的内容已经有了，你只需要添加绿色字体的内容。可以通过红色字，在文件中定位。但模拟环境没有加，需要你全部手动添加。这样是为了练习，万一考试中没有，你也会加。但是如果考试中已添加，你再添加一遍，则会报错，导致<span
lang=EN-US>api-server</span>启不起来。</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp; -
mountPath: </span><span lang=EN-US style='color:red'>/etc/kubernetes/epconfig</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
name: epconfig</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#readOnly: true</span></p>

<p class=MsoNormal><span lang=EN-US style='color:red'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
#1.22</span><span style='color:red'>考试的时候，会有个<span lang=EN-US>readOnly:true</span>删掉这行</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US># </span>在<span lang=EN-US>kube-apiserver.yaml</span>的<span
lang=EN-US>volumes </span>增加</p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp; volumes:&nbsp;
</span><span lang=EN-US>&nbsp;<span style='color:#0070C0'>#</span></span><span
style='color:#0070C0'>在<span lang=EN-US>volumes</span>下面增加 <span lang=EN-US>&nbsp;&nbsp;</span></span><span
lang=EN-US style='color:red'>#</span><span style='color:red'>注意，在<span
lang=EN-US>1.22</span>考试中，蓝色的内容已经有了，你只需要添加绿色字体的内容。可以通过红色字，在文件中定位。但模拟环境没有加，需要你全部手动添加。这样是为了练习，万一考试中没有，你也会加。但是如果考试中已添加，你再添加一遍，则会报错，导致<span
lang=EN-US>api-server</span>启不起来。</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp; - name:
epconfig</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp; &nbsp;&nbsp;hostPath:</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#0070C0'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
path: </span><span lang=EN-US style='color:red'>/etc/kubernetes/epconfig</span></p>

<p class=MsoNormal><span lang=EN-US style='color:#00B050'>&nbsp;&nbsp;&nbsp; </span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>第四步，重启<span lang=EN-US>kubelet</span>，并创建测试的<span
lang=EN-US>pod</span>（<span style='color:red'>仅模拟一下命令吧，因为无法完全实现模拟环境</span>）</p>

<p class=MsoNormal align=left style='text-align:left'>（因为环境未搭建<span lang=EN-US>webhook
server</span>，所以重启<span lang=EN-US>kubelet</span>会报错。）</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>systemctl restart kubelet</span></p>

<p class=MsoNormal align=left style='text-align:left'>（因为环境未搭建<span lang=EN-US>webhook
server</span>，创建会报错，仅模拟一下命令吧。）</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>kubectl apply -f /csk/img/web1.yaml</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>验证，不允许使用<span lang=EN-US>latest</span>的镜像<span
lang=EN-US>:</span>（<span style='color:red'>仅模拟一下命令吧，因为无法完全实现模拟环境</span>）</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>kubectl run pod1 --image=nginx</span></p>

<p class=MsoNormal align=left style='text-align:left'>考试时，会报错，提示策略拒绝。</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>Error
from server (Forbidden): pods &quot;pod1&quot; is forbidden: image policy
webhook backend denied one or more images: Images using latest tag are not
allowed</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'>查看容器扫描日志（<span
style='color:red'>仅模拟一下命令吧，因为无法完全实现模拟环境</span>）：</p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US
style='color:#C45911'>tail /var/log/imagepolicy/roadrunner.log</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal align=left style='text-align:left'><span lang=EN-US>&nbsp;</span></p>

</div>

</body>

</html>
